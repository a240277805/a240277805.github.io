<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://a240277805.github.io/page/14/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://a240277805.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2022/每日一问0719(nats)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0719(nats)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.360Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2022/">2022</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0719(nats)/">每日一问0719(nats)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="nats"><a href="#nats" class="headerlink" title="nats"></a>nats</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li>nats 特点</li>
<li>nats 定位 </li>
<li>nats 使用场景</li>
<li>nats 使用和 kafka ，redis 对比</li>
<li>nats 使用应避免的坑</li>
<li>nats 高级特性使用例子   source ，镜像</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0719(nats)/" data-id="cld1bs9uo004efynhesu82sun" data-title="每日一问0719(nats)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2022/每日一问0723(jenkins流水线)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0723(jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.360Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2022/">2022</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0723(jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF)/">每日一问0723(jenkins流水线)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="jenkins-流水线部署"><a href="#jenkins-流水线部署" class="headerlink" title="jenkins 流水线部署"></a>jenkins 流水线部署</h1><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><p>prod devplatformserver  pipeline script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">def ProdServer()&#123;</span><br><span class="line">    def remote = [:]</span><br><span class="line">    remote.name = &quot;172.20.60.16&quot;</span><br><span class="line">    remote.host = &quot;172.20.60.16&quot;</span><br><span class="line">    remote.port = 22</span><br><span class="line">    remote.allowAnyHosts = true</span><br><span class="line">    withCredentials([usernamePassword(credentialsId: &#x27;prod-k8s-master1_host-root&#x27;, passwordVariable: &#x27;password&#x27;, usernameVariable: &#x27;userName&#x27;)]) &#123;</span><br><span class="line">        remote.user = &quot;$&#123;userName&#125;&quot;</span><br><span class="line">        remote.password = &quot;$&#123;password&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    return remote</span><br><span class="line">&#125;</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        label &#x27;jenkins-slave&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        def DEVOPS_PIPELINE_HOME = &quot;/jenkins_pod_data/devops_server/pipeline_home&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    // parameters &#123; string(name: &#x27;git_branch&#x27;, defaultValue: &#x27;20201113-zmk-k8sdeploy&#x27;, description: &#x27;输入需要发布的分支名称&#x27;) &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Java Build&#x27;) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                git branch: &quot;master&quot;,</span><br><span class="line">                url: &#x27;https://git.ctfo.com/devops/devplatform-server.git&#x27;,</span><br><span class="line">                credentialsId: &#x27;dbddbe0b-bfec-4f40-9b9a-a2f5a4bba4fd&#x27;</span><br><span class="line">                script&#123;</span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        ### create git-version</span><br><span class="line">                        cd deploy-k8s/jenkins;/bin/bash git-version.sh</span><br><span class="line">                        DOCKER_TAG=`cat git-version`</span><br><span class="line">                        echo $DOCKER_TAG</span><br><span class="line">                        cd ../../</span><br><span class="line"></span><br><span class="line">                        mvn clean package</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Docker Build image&#x27;)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                withCredentials([usernamePassword(credentialsId: &#x27;admin-harbor.ctfo.com&#x27;, passwordVariable: &#x27;harbor_password&#x27;, usernameVariable: &#x27;harbor_username&#x27;)]) &#123;</span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                    docker login -u $harbor_username -p $harbor_password harbor.ctfo.com</span><br><span class="line">                    DOCKER_TAG=`cat deploy-k8s/jenkins/git-version`</span><br><span class="line">                    echo $DOCKER_TAG</span><br><span class="line">                    docker build -t harbor.ctfo.com/devops/devplatform-server:$DOCKER_TAG .</span><br><span class="line">                    docker push harbor.ctfo.com/devops/devplatform-server:$DOCKER_TAG</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Deploy k8s Pod&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                def sshServer = ProdServer()</span><br><span class="line">                sshPut remote: sshServer, from: &quot;deploy-k8s/jenkins/git-version&quot;, into: &quot;/tmp/prod-server.version&quot;</span><br><span class="line">                sshPut remote: sshServer, from: &quot;deploy-k8s/jenkins/prod-deploy-k8s.sh&quot;, into: &quot;/tmp/prod-server.sh&quot;</span><br><span class="line">                sshCommand remote: sshServer, command: &quot;bash -x /tmp/prod-server.sh /tmp/prod-server.version&quot;</span><br><span class="line">                ssh &#x27;&#x27;&#x27;</span><br><span class="line">                    sleep 90</span><br><span class="line">                &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>报警 k8s 部署 k8s jenkins-pipeline script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br></pre></td><td class="code"><pre><span class="line">def server_d5f217261c364cc1b9c0280f64a90275()&#123;</span><br><span class="line">    def remote = [:]</span><br><span class="line">    remote.name = &quot;172.20.60.95&quot;</span><br><span class="line">    remote.host = &quot;172.20.60.95&quot;</span><br><span class="line">    withCredentials([usernamePassword(credentialsId: &#x27;Mzk2OjIwMjAxMDIyMDgxMTA3MzQ1MjMzMTA4MDE2MDAwMDAxOui3r+WPo+S6keerry3lvIDlj5E=&#x27;, passwordVariable: &#x27;password&#x27;, usernameVariable: &#x27;userName&#x27;)]) &#123;</span><br><span class="line">        remote.user = &quot;$userName&quot;</span><br><span class="line">        remote.password = &quot;$password&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    remote.port = 22</span><br><span class="line">    remote.allowAnyHosts = true</span><br><span class="line">    return remote</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        kubernetes &#123;</span><br><span class="line">            yaml &quot;&quot;&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    appName: 7aaf8dcff4f046b695a4204c8a516460</span><br><span class="line">  namespace: jenkins</span><br><span class="line">spec:</span><br><span class="line">  hostAliases:</span><br><span class="line">  - hostnames:</span><br><span class="line">    - harbordev.ctfo.com</span><br><span class="line">    ip: 172.20.80.7</span><br><span class="line">  - hostnames:</span><br><span class="line">    - harbordev-public.ctfo.com</span><br><span class="line">    ip: 172.20.60.31</span><br><span class="line">  containers:</span><br><span class="line">  - name: jnlp</span><br><span class="line">    image: harbor.ctfo.com/jenkins/inbound-agent:4.6-1-alpine-baseimage-10</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    env:</span><br><span class="line">    - name: SLAVE_NODE_NAME</span><br><span class="line">      valueFrom:</span><br><span class="line">        fieldRef:</span><br><span class="line">          fieldPath: spec.nodeName</span><br><span class="line">    - name: SLAVE_NODE_IP</span><br><span class="line">      valueFrom:</span><br><span class="line">        fieldRef:</span><br><span class="line">          fieldPath: status.hostIP</span><br><span class="line">    securityContext:</span><br><span class="line">      privileged: true</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;1024Mi&quot;</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: &quot;volume-docker&quot;</span><br><span class="line">      mountPath: &quot;/var/run/docker.sock&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">    - name: &quot;volume-share&quot;</span><br><span class="line">      subPath: &quot;jenkins_plugin_bin/docker/cli-plugins&quot;</span><br><span class="line">      mountPath: &quot;/usr/libexec/docker/cli-plugins&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">    - name: &quot;volume-share&quot;</span><br><span class="line">      subPath: &quot;jenkins_plugin_bin/docker/docker&quot;</span><br><span class="line">      mountPath: &quot;/usr/bin/docker&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">    - name: &quot;volume-share&quot;</span><br><span class="line">      subPath: &quot;jenkins_plugin_bin/mc_bin/mc&quot;</span><br><span class="line">      mountPath: &quot;/usr/bin/mc&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">    - name: &quot;volume-share&quot;</span><br><span class="line">      subPath: &quot;jenkins_plugin_bin/jenkins_bin/dingtalk&quot;</span><br><span class="line">      mountPath: &quot;/usr/bin/dingtalk&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">    - name: &quot;volume-share&quot;</span><br><span class="line">      mountPath: &quot;/jenkins_pod_data&quot;</span><br><span class="line">      readOnly: false</span><br><span class="line">  nodeSelector:</span><br><span class="line">    devops-server-type: devops-jenkins-slave</span><br><span class="line">  restartPolicy: &quot;Never&quot;</span><br><span class="line">  tolerations:</span><br><span class="line">  - effect: &quot;NoSchedule&quot;</span><br><span class="line">    key: &quot;prod-devops-tolerations&quot;</span><br><span class="line">    operator: &quot;Exists&quot;</span><br><span class="line">  volumes:</span><br><span class="line">  - name: volume-docker</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /var/run/docker.sock</span><br><span class="line">  - name: volume-share</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: jenkins-poddata-pvc</span><br><span class="line">      readOnly: false</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage (&quot;start callback&quot;)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(&#x27;jnlp&#x27;) &#123;</span><br><span class="line">                    writeFile (file: &#x27;/usr/bin/ccsupgrade.sh&#x27;, text: &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">CCS_CHECK=true</span><br><span class="line">if [ &quot;$CCS_API&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云地址未设置!(export CCS_API=http://CCS_IP:30888)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_USERNAME&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云账号未设置!(export CCS_USERNAME=admin)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_PASSWORD&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云密码未设置!(export CCS_PASSWORD=123456)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_REGISTRY&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云仓库地址未设置!(export CCS_REGISTRY=REGISTRY_IP:5000)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_CLUSTER&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云集群名称未设置!(export CCS_CLUSTER=main)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_NAMESPACE&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云命令空间未设置!(export CCS_NAMESPACE=namespace)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_DEPLOYMENT&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云部署名称未设置!(export CCS_DEPLOYMENT=deployname)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_CONTAINER&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云容器名称未设置!(export CCS_CONTAINER=containername)&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># login ccs get token</span><br><span class="line">CCS_TOKEN=$(curl -X POST -H &#x27;Cookie: csrfToken=pipeline&#x27; -H &#x27;x-csrf-token: pipeline&#x27; -H &#x27;Content-Type: application/json&#x27; \\</span><br><span class="line">-d &#x27;&#123;&quot;username&quot;: &quot;&#x27;$CCS_USERNAME&#x27;&quot;, &quot;password&quot;: &quot;&#x27;$CCS_PASSWORD&#x27;&quot;&#125;&#x27; \\</span><br><span class="line">&quot;$CCS_API/api/ccs/auth/v1/login&quot; | jq .data | cut -d\\&quot; -f2)</span><br><span class="line"></span><br><span class="line">if [ &quot;$CCS_TOKEN&quot; == &quot;&quot; ];then</span><br><span class="line">  echo &#x27;敏捷云认证失败! 请检查CCS_USERNAME CCS_PASSWORD变量&#x27;</span><br><span class="line">  CCS_CHECK=false</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 检查失败退出</span><br><span class="line">if [ &quot;$CCS_CHECK&quot; == &quot;false&quot; ];then</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;检查通过!&quot;</span><br><span class="line">echo &quot;开上下载镜像...&quot;</span><br><span class="line">docker pull $IMAGE_TAG</span><br><span class="line">docker save $IMAGE_TAG -o /tmp/image.tar</span><br><span class="line"></span><br><span class="line">echo &quot;开始上传镜像...&quot;</span><br><span class="line">curl --proxy 172.17.5.60:32146 -X POST -H &quot;Cookie: csrfToken=pipeline; ccsToken=$CCS_TOKEN&quot; -H &#x27;x-csrf-token: pipeline&#x27; -F &quot;file=@/tmp/image.tar&quot; \\</span><br><span class="line">&quot;$CCS_API/api/ccs/apps/v1/imageStores/default/importImageTar&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;开始更新镜像...&quot;</span><br><span class="line"># upgrade ccs deployment</span><br><span class="line">curl -XPATCH -H &quot;Cookie: csrfToken=pipeline; ccsToken=$CCS_TOKEN&quot; \\</span><br><span class="line">-H &#x27;x-csrf-token: pipeline&#x27; -H &quot;Content-Type: application/strategic-merge-patch+json&quot; \\</span><br><span class="line">-d &#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;&#x27;$&#123;IMAGE_TAG/harbor.ctfo.com/$CCS_REGISTRY&#125;&#x27;&quot;,&quot;name&quot;:&quot;&#x27;$CCS_CONTAINER&#x27;&quot;&#125;]&#125;&#125;&#125;&#125;&#x27; \\</span><br><span class="line">&quot;$CCS_API/api/ccs/k8s/v1/clusters/$CCS_CLUSTER/namespaces/$CCS_NAMESPACE/deployments/$CCS_DEPLOYMENT&quot;</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">                    writeFile (file: &#x27;/usr/bin/dingtalk.sh&#x27;, text: &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">export DOCKER_HOST=tcp://172.20.3.61:2375;</span><br><span class="line">docker run --rm \\</span><br><span class="line">-e DRONE_BUILD_LINK=&quot;$BUILD_URL&quot; \\</span><br><span class="line">-e DRONE_COMMIT_MESSAGE=&quot;$GIT_COMMIT_MSG&quot; \\</span><br><span class="line">-e DRONE_COMMIT_AUTHOR=&quot;$GIT_COMMITTER_NAME&quot; \\</span><br><span class="line">-e DRONE_COMMIT_AUTHOR_EMAIL=&quot;$GIT_COMMITTER_EMAIL&quot; \\</span><br><span class="line">-e DRONE_BUILD_NUMBER=&quot;$BUILD_NUMBER&quot; \\</span><br><span class="line">-e DRONE_COMMIT_BRANCH=&quot;$GIT_PULL_RESOURCE&quot; \\</span><br><span class="line">-e DRONE_REPO_NAME=&quot;$JOB_NAME&quot; \\</span><br><span class="line">-e DRONE_BUILD_STATUS=&quot;success&quot; \\</span><br><span class="line">-e DRONE_COMMIT_SHA=&quot;$GIT_COMMIT&quot; \\</span><br><span class="line">-e DRONE_COMMIT_LINK=&quot;https://git.ctfo.com/znlk/backend/cloud_java/ctfo-cloud-alertevent/-/commit/$GIT_COMMIT&quot; \\</span><br><span class="line">-e DRONE_REMOTE_URL=&quot;https://git.ctfo.com/znlk/backend/cloud_java/ctfo-cloud-alertevent.git&quot; \\</span><br><span class="line">-e PLUGIN_TOKEN=$1 \\</span><br><span class="line">-e PLUGIN_SECRET=$2 \\</span><br><span class="line">-e PLUGIN_MSG_TYPE=markdown \\</span><br><span class="line">harbor.ctfo.com/devops-public/drone-dingtalk-message;</span><br><span class="line">unset DOCKER_HOST</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        echo &quot;jenkins pipeline is Schedule on node $SLAVE_NODE_NAME&quot;</span><br><span class="line">                        curl -X POST &quot;https://devops-api.ctfo.com/ctfo-devplatform-server/api/callback/v1/jenkins/build/start?uniqueKey=$uniqueKey&amp;buildNum=$BUILD_NUMBER&quot;</span><br><span class="line">                        docker buildx create --name mulit-archs --use --driver-opt image=harbor.ctfo.com/devops-public/buildkit:buildx-stable-1,network=host --node mulit-archs</span><br><span class="line"></span><br><span class="line">                        mkdir -p /jenkins_pod_data/devops_server/pipeline_home/7aaf8dcff4f046b695a4204c8a516460 /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460</span><br><span class="line">                        echo VERSION_FILE=/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION &gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo BUILD_START=$(date +%s) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo BUILD_DATE=$(date &quot;+%Y-%m-%d&quot;) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo BUILD_TIME=$(date &quot;+%H:%M:%S&quot;) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo IMAGE_TAG_GIT=$IMAGE_TAG &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo MINIO_PREFIX=$(echo $MINIO_PREFIX | awk -F / &#x27;&#123;print $1&quot;/&quot;$2&quot;/&#x27;$IMAGE_TAG&#x27;/&quot;$4&#125;&#x27;) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                        echo SLAVE_NODE_IP=$SLAVE_NODE_IP &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line"></span><br><span class="line">                        chmod +x /usr/bin/dingtalk.sh /usr/bin/ccsupgrade.sh /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 镜像构建 镜像构建 pipeline_image_build/pipeline_java_build</span><br><span class="line">        stage(&#x27;b6644a5e94c04fd79c29659e3847df71&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">            </span><br><span class="line">                container(&#x27;jnlp&#x27;) &#123;</span><br><span class="line">                    checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;$GIT_PULL_RESOURCE&#x27;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[</span><br><span class="line">                        credentialsId: &#x27;Mzk2OjIwMjAwOTE2MDkxMTM4MDA4MDIwMDE0MDI1MDAwMDAxOnB5bQ==&#x27;, url: &#x27;https://git.ctfo.com/znlk/backend/cloud_java/ctfo-cloud-alertevent.git&#x27;</span><br><span class="line">                    ]]])</span><br><span class="line"></span><br><span class="line">                    withCredentials([usernamePassword(credentialsId: &#x27;Mzk2OjIwMjAwOTE2MDkxMTM4MDA4MDIwMDE0MDI1MDAwMDAxOnB5bQ==&#x27;, usernameVariable: &#x27;git_username&#x27;, passwordVariable: &#x27;git_password&#x27;)]) &#123;</span><br><span class="line">                        sh &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">                            GIT_COMMIT=$(git rev-parse --short HEAD)</span><br><span class="line">                            echo GIT_COMMIT=$GIT_COMMIT &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                            #echo GIT_COMMIT_MSG=&quot;msg: $(git log -1 --pretty=%B $GIT_COMMIT)&quot; &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                            echo GIT_COMMITTER_NAME=$(git log -1 --pretty=%cn $GIT_COMMIT) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                            echo GIT_COMMITTER_EMAIL=$(git log -1 --pretty=%ce $GIT_COMMIT) &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION</span><br><span class="line">                            </span><br><span class="line">                            echo docker login -u $git_username -p \\&#x27;$git_password\\&#x27; harbor.ctfo.com &gt; /tmp/login_harbor</span><br><span class="line">                            sed -i &#x27;s#\\$\\$#$#g&#x27; /tmp/login_harbor</span><br><span class="line">                            sh /tmp/login_harbor || true</span><br><span class="line"></span><br><span class="line">                            GIT_PASSWORD=$(echo $git_password | tr -d &#x27;\n&#x27; | od -An -tx1| tr &#x27; &#x27; %)</span><br><span class="line">                            echo &#x27;git config --global url.&quot;https://&#x27;$git_username&#x27;:&#x27;$GIT_PASSWORD&#x27;@git.ctfo.com&quot;.insteadOf &quot;https://git.ctfo.com&quot;&#x27; &gt; .git_init.sh</span><br><span class="line">                            sh .git_init.sh</span><br><span class="line"></span><br><span class="line">                            #rm -rf .dockerignore</span><br><span class="line">                            echo *.dockerfile &gt; .dockerignore</span><br><span class="line">                        &#x27;&#x27;&#x27;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line">                    script &#123;</span><br><span class="line">                        readProperties(text: readFile(file: &#x27;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION&#x27;)).each &#123;</span><br><span class="line">                            env.&quot;$&#123;it.key&#125;&quot; = &quot;$&#123;it.value&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                container(&#x27;jnlp&#x27;)&#123;</span><br><span class="line">                    writeFile (file: &#x27;compile-shell-b6644a5e94c04fd79c29659e3847df71.sh&#x27;, text: &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line"># 加载全局的环境变量, 以便在脚本中直接使用</span><br><span class="line">IFS_O=$IFS; IFS=$&#x27;\n\n&#x27;; for line in $(cat compile-env-b6644a5e94c04fd79c29659e3847df71.sh); do export $line;done; IFS=$IFS_O</span><br><span class="line"></span><br><span class="line"># 执行不同语言的预处理脚本</span><br><span class="line">/usr/local/bin/mvn-entrypoint.sh || true</span><br><span class="line"></span><br><span class="line"># 开启执行跟踪</span><br><span class="line">set -xe</span><br><span class="line"></span><br><span class="line"># 执行用户的编译脚本, 里面可以直接使用全局的环境变量</span><br><span class="line">mvn clean package -DskipTests</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line">                    writeFile (file: &#x27;compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile&#x27;, text: &#x27;&#x27;&#x27;FROM --platform=$BUILDPLATFORM harbor.ctfo.com/jenkins/maven:3.8.2-jdk-8-buildjava-12 as pipeline-builder</span><br><span class="line">ARG BUILDPLATFORM</span><br><span class="line">ARG BUILDOS</span><br><span class="line">ARG BUILDARCH</span><br><span class="line">ARG TARGETPLATFORM</span><br><span class="line">ARG TARGETOS</span><br><span class="line">ARG TARGETARCH</span><br><span class="line">WORKDIR /root</span><br><span class="line">COPY . .</span><br><span class="line">RUN sh compile-shell-b6644a5e94c04fd79c29659e3847df71.sh</span><br><span class="line">FROM scratch</span><br><span class="line">ARG BUILDPLATFORM</span><br><span class="line">ARG BUILDOS</span><br><span class="line">ARG BUILDARCH</span><br><span class="line">ARG TARGETPLATFORM</span><br><span class="line">ARG TARGETOS</span><br><span class="line">ARG TARGETARCH</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">                    writeFile (file: &#x27;ctfo_prepare-b6644a5e94c04fd79c29659e3847df71.sh&#x27;, text: &#x27;&#x27;&#x27;&#x27;&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">                    sh &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">                        set -xe</span><br><span class="line">                        # 编译制品</span><br><span class="line">                        mkdir -p /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71</span><br><span class="line">                        cp /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/CTFO_VERSION /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                        echo &quot;ARTIFACTS_PATH=/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71&quot; &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                        echo &quot;WORKDIR=/app&quot; &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                        </span><br><span class="line">                        </span><br><span class="line"></span><br><span class="line">                        cp /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION compile-env-b6644a5e94c04fd79c29659e3847df71.sh</span><br><span class="line"></span><br><span class="line">                        chmod +x compile-shell-b6644a5e94c04fd79c29659e3847df71.sh</span><br><span class="line"></span><br><span class="line">                        echo &#x27;#!/bin/sh -e</span><br><span class="line">exec java \\</span><br><span class="line">    $JAVA_OPTS \\</span><br><span class="line">    -Djava.security.egd=file:/dev/./urandom \\</span><br><span class="line">    -Dfile.encoding=UTF-8 \\</span><br><span class="line">    -Dsun.jnu.encoding=UTF-8 \\</span><br><span class="line">    -jar /app//alerevent-0.0.1-SNAPSHOT.jar \\</span><br><span class="line">    $*</span><br><span class="line">    &#x27; &gt; ctfo_entrypoint-b6644a5e94c04fd79c29659e3847df71.sh</span><br><span class="line">                        chmod +x ctfo_entrypoint-b6644a5e94c04fd79c29659e3847df71.sh</span><br><span class="line"></span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                </span><br><span class="line">                container(&#x27;jnlp&#x27;) &#123;</span><br><span class="line">                    script &#123;</span><br><span class="line">                        readProperties(text: readFile(file: &#x27;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION&#x27;)).each &#123;</span><br><span class="line">                            env.&quot;$&#123;it.key&#125;&quot; = &quot;$&#123;it.value&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        echo &#x27;COPY --from=pipeline-builder /root/target/alerevent-0.0.1-SNAPSHOT.jar //app/&#x27; &gt;&gt; compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile</span><br><span class="line">                      </span><br><span class="line">                        echo &quot;$RUNCOPY&quot; | sed &#x27;s#^\\s*COPY\\s*#COPY --from=pipeline-builder /root/#g&#x27; &gt;&gt; compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile</span><br><span class="line">                      </span><br><span class="line">                        # 无架构编译</span><br><span class="line">                        if [ -f compile-shell-b6644a5e94c04fd79c29659e3847df71.sh ];then</span><br><span class="line">                            docker buildx build -f compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile -o type=local,dest=/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/linux_amd64 .</span><br><span class="line">                        fi</span><br><span class="line">                        cd $WORKSPACE</span><br><span class="line">                        </span><br><span class="line">                        export TARGETPLATFORM=linux/amd64</span><br><span class="line">                        export TARGETOS=linux</span><br><span class="line">                        export TARGETARCH=amd64</span><br><span class="line">                        if [ ! -f compile-shell-b6644a5e94c04fd79c29659e3847df71.sh ];then</span><br><span class="line">                            mkdir -p /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/linux_amd64</span><br><span class="line">                            cp -r target/alerevent-0.0.1-SNAPSHOT.jar /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/linux_amd64//app/</span><br><span class="line">                        fi</span><br><span class="line"></span><br><span class="line">                        BUCKET_NAME=znlk-cloud</span><br><span class="line">                        BIN_FILE_NAME=/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/ctfo-cloud-alertevent.tar.gz</span><br><span class="line">                        MINIO_PATH=$BUCKET_NAME/ctfo-cloud-alertevent/$MINIO_PREFIX</span><br><span class="line"></span><br><span class="line">                        # 先进入制品目录</span><br><span class="line">                        cd /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/linux_amd64</span><br><span class="line"></span><br><span class="line">                        FILE_NUM=$(find -type f| wc -l)</span><br><span class="line">                        if [[ $FILE_NUM -eq 1 ]];then</span><br><span class="line">                            PUSH_FILE_NAME=/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/linux_amd64/$(find -type f)</span><br><span class="line">                        else</span><br><span class="line">                            tar -czf $BIN_FILE_NAME *</span><br><span class="line">                            PUSH_FILE_NAME=$BIN_FILE_NAME</span><br><span class="line">                        fi</span><br><span class="line">                        echo &quot;BIN_FILE_NAME_amd64=$PUSH_FILE_NAME&quot; &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                        echo &quot;BIN_FILE_NUM_amd64=$FILE_NUM&quot; &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line"></span><br><span class="line">                        # 制作待推送文件的  md5 文件</span><br><span class="line">                        FILE_NAME_MD5=$(md5sum $PUSH_FILE_NAME | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">                        FILE_NAME=$(basename $PUSH_FILE_NAME)</span><br><span class="line">                        echo $FILE_NAME_MD5 $FILE_NAME&gt; $PUSH_FILE_NAME.md5</span><br><span class="line"></span><br><span class="line">                        # 创建bucket, 分配下载权限</span><br><span class="line">                        mc mb http_prod-minio-devops/$BUCKET_NAME || true</span><br><span class="line">                        mc policy set download http_prod-minio-devops/$BUCKET_NAME || true</span><br><span class="line">                        mc cp $PUSH_FILE_NAME http_prod-minio-devops/$MINIO_PATH/$FILE_NAME</span><br><span class="line">                        mc cp $PUSH_FILE_NAME.md5 http_prod-minio-devops/$MINIO_PATH/$FILE_NAME_MD5.md5</span><br><span class="line">                        echo &quot;&#123;</span><br><span class="line">                            \\&quot;stageId\\&quot;:\\&quot;b6644a5e94c04fd79c29659e3847df71\\&quot;,</span><br><span class="line">                            \\&quot;pushMinioResult\\&quot;:\\&quot;$(mc ls http_prod-minio-devops/$MINIO_PATH/$FILE_NAME)\\&quot;,</span><br><span class="line">                            \\&quot;minioPath\\&quot;:\\&quot;$MINIO_PATH/$FILE_NAME\\&quot;,</span><br><span class="line">                            \\&quot;bucketName\\&quot;:\\&quot;$BUCKET_NAME\\&quot;,</span><br><span class="line">                            \\&quot;fileName\\&quot;:\\&quot;$FILE_NAME\\&quot;</span><br><span class="line">                        &#125;&quot; &gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71_buildparam.txt</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                                container(&#x27;jnlp&#x27;) &#123;</span><br><span class="line">                    withCredentials([usernamePassword(credentialsId: &#x27;Mzk2OjIwMjAwOTE2MDkxMTM4MDA4MDIwMDE0MDI1MDAwMDAxOnB5bQ==&#x27;, usernameVariable: &#x27;harbor_username&#x27;, passwordVariable: &#x27;harbor_password&#x27;)]) &#123;</span><br><span class="line">                        sh &#x27;&#x27;&#x27;</span><br><span class="line">                            echo docker login -u $harbor_username -p \\&#x27;$harbor_password\\&#x27; harbor.ctfo.com &gt; /tmp/login_harbor</span><br><span class="line">                            sed -i &#x27;s#\\$\\$#$#g&#x27; /tmp/login_harbor</span><br><span class="line">                            sh /tmp/login_harbor</span><br><span class="line">                            export BASE_IMAGE_DIGEST=$(curl -k &#x27;https://$harbor_username:$harbor_password@harbor.ctfo.com/api/v2.0/projects/jenkins/repositories/openjdk/artifacts&#x27; | jq &#x27;[foreach .[] as $item ([]; $item; if $item.tags == null then empty else $item end)] | [foreach .[] as $item ([]; $item; if $item.tags[].name == &quot;8-runjava-10&quot; then $item.digest else empty end)] | first&#x27; | xargs)</span><br><span class="line">                            if [ &quot;$BASE_IMAGE_DIGEST&quot; != &quot;&quot; ] ; then</span><br><span class="line">                              echo &quot;BASE_IMAGE_DIGEST=$BASE_IMAGE_DIGEST&quot; &gt;&gt;  /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                            fi</span><br><span class="line">                        &#x27;&#x27;&#x27;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    script &#123;</span><br><span class="line">                        readProperties(text: readFile(file: &#x27;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION&#x27;)).each &#123;</span><br><span class="line">                            env.&quot;$&#123;it.key&#125;&quot; = &quot;$&#123;it.value&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                        env.IMAGE_TAG = &quot;harbor.ctfo.com/test-public/ctfo-cloud-alertevent:&quot; + env.IMAGE_TAG</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    sh &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">                        # 设置环境变量</span><br><span class="line">                        echo IMAGE_TAG=$IMAGE_TAG &gt;&gt; /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION</span><br><span class="line">                        set -xe</span><br><span class="line"></span><br><span class="line">                        sed -i &#x27;/COPY --from=/d&#x27; compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile</span><br><span class="line">                        if [ -f ./Dockerfile ]; then</span><br><span class="line">                          cat ./Dockerfile | sed &#x27;/--from=/!s#^\\s*COPY\\s*#COPY --from=pipeline-builder /root/#g&#x27; | sed &#x27;/--from=/!s#^\\s*ADD\\s*#COPY --from=pipeline-builder /root/#g&#x27; &gt;&gt; compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile</span><br><span class="line">                        elif [ -f ./Dockerfile/Dockerfile ]; then</span><br><span class="line">                          cat ./Dockerfile/Dockerfile | sed &#x27;/--from=/!s#^\\s*COPY\\s*#COPY --from=pipeline-builder /root/#g&#x27; | sed &#x27;/--from=/!s#^\\s*ADD\\s*#COPY --from=pipeline-builder /root/#g&#x27; &gt;&gt; compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile</span><br><span class="line">                        else</span><br><span class="line">                          echo &quot;./Dockerfile not exist Dockerfile!&quot;</span><br><span class="line">                          exit 1</span><br><span class="line">                        fi</span><br><span class="line">                        </span><br><span class="line">                        docker buildx build --platform linux/amd64 -t $IMAGE_TAG -f compile-docker-b6644a5e94c04fd79c29659e3847df71.dockerfile --push .</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 部署 K8S发布 pipeline_deploy/deploy_k8s_upgrade</span><br><span class="line">        stage(&#x27;d5f217261c364cc1b9c0280f64a90275&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">            </span><br><span class="line">                container(&#x27;jnlp&#x27;) &#123;</span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        mkdir -p /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275</span><br><span class="line">                        cp /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/b6644a5e94c04fd79c29659e3847df71/CTFO_VERSION /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">                    script &#123;</span><br><span class="line">                        readProperties(text: readFile(file: &#x27;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275/CTFO_VERSION&#x27;)).each &#123;</span><br><span class="line">                            env.&quot;$&#123;it.key&#125;&quot; = &quot;$&#123;it.value&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    writeFile (file: &#x27;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275/deploy_k8s_upgrade_d5f217261c364cc1b9c0280f64a90275.sh&#x27;, text: &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">if [ -f CTFO_VERSION ] ; then IFS_O=$IFS; IFS=$&#x27;\n\n&#x27;; for line in $(cat CTFO_VERSION); do export $line;done; IFS=$IFS_O; fi</span><br><span class="line"></span><br><span class="line">set -xe</span><br><span class="line"></span><br><span class="line">set -xe</span><br><span class="line">export IS_RESTART=$(kubectl set image Deployment ctfo-cloud-alertevent -n znlk-cloud ctfo-cloud-alertevent=$IMAGE_TAG)</span><br><span class="line">if [ &quot;$IS_RESTART&quot; == &quot;&quot; ];then</span><br><span class="line">    kubectl rollout restart -n znlk-cloud Deployment ctfo-cloud-alertevent</span><br><span class="line">fi</span><br><span class="line">                        </span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        cd /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275</span><br><span class="line">                        chmod +x /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275/deploy_k8s_upgrade_d5f217261c364cc1b9c0280f64a90275.sh</span><br><span class="line">                        tar -czf deployment.tgz *</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                    </span><br><span class="line">                    script &#123;</span><br><span class="line">                        def remote = server_d5f217261c364cc1b9c0280f64a90275()</span><br><span class="line">                        sshCommand remote: remote, command: &quot;mkdir -p /tmp/d5f217261c364cc1b9c0280f64a90275&quot;</span><br><span class="line">                        sshPut remote: remote, from: &quot;/home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275/deployment.tgz&quot;, into: &quot;/tmp/d5f217261c364cc1b9c0280f64a90275&quot;</span><br><span class="line">                        sshCommand remote: remote, command: &#x27;&#x27;&#x27;</span><br><span class="line">                            cd /tmp/d5f217261c364cc1b9c0280f64a90275; tar -xzf deployment.tgz; rm -f deployment.tgz</span><br><span class="line">                            nohup bash -x deploy_k8s_upgrade_d5f217261c364cc1b9c0280f64a90275.sh &gt; service.log 2&gt;&amp;1 &amp;</span><br><span class="line">                        &#x27;&#x27;&#x27;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    sh &#x27;&#x27;&#x27;</span><br><span class="line">                        rm -rf /home/jenkins/agent/7aaf8dcff4f046b695a4204c8a516460/d5f217261c364cc1b9c0280f64a90275</span><br><span class="line">                    &#x27;&#x27;&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    post &#123;</span><br><span class="line">        always &#123;</span><br><span class="line">            script &#123;</span><br><span class="line">                execCode = sh(script: &#x27;&#x27;&#x27;</span><br><span class="line">                  curl -X POST &quot;https://devops-api.ctfo.com/ctfo-devplatform-server/api/callback/v1/jenkins/build/finished?uniqueKey=$uniqueKey&amp;buildNum=$BUILD_NUMBER&quot;</span><br><span class="line">                &#x27;&#x27;&#x27;, returnStatus: true)</span><br><span class="line">                echo &quot;$execCode&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0723(jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF)/" data-id="cld1bs9up004ffynhbotu2qdi" data-title="每日一问0723(jenkins流水线)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/EDAS 评估方案" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/EDAS%20%E8%AF%84%E4%BC%B0%E6%96%B9%E6%A1%88/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/EDAS%20%E8%AF%84%E4%BC%B0%E6%96%B9%E6%A1%88/">EDAS 评估方案</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="EDAS-评估方案工作量"><a href="#EDAS-评估方案工作量" class="headerlink" title="EDAS 评估方案工作量"></a>EDAS 评估方案工作量</h1><h2 id="1d-准备"><a href="#1d-准备" class="headerlink" title="1d 准备"></a>1d 准备</h2><ol>
<li>准备 provide,consumer 两个Spring cloud demo 项目，准备测试服务调用</li>
<li>准备Springcloud demo 项目，增加正确调用接口<ul>
<li>测试调用链</li>
<li>测试服务鉴权</li>
<li>测试限流降级</li>
</ul>
</li>
<li>准备Springcloud demo 项目，增加错误调用接口 测试离群实例摘除策略</li>
</ol>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="评估内容"><a href="#评估内容" class="headerlink" title="评估内容"></a>评估内容</h3><h3 id="1d部署"><a href="#1d部署" class="headerlink" title="1d部署"></a>1d部署</h3><ol>
<li><p>ECS部署</p>
</li>
<li><p>K8s 部署</p>
</li>
</ol>
<ul>
<li>配置调度规则</li>
<li>配置启动命令</li>
<li>配置环境变量</li>
<li>配置持久化存储</li>
<li>配置本地存储</li>
<li>配置应用生命周期的钩子和探针</li>
<li>配置日志收集</li>
<li>配置Tomcat</li>
<li>配置Java启动参数</li>
<li>实现Ks集群应用的限流降级</li>
</ul>
<p>（添加公网SLB实现公网访问）</p>
<p>参考： <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/158047.html?spm=a2c4g.11186623.6.590.8e627c71tUMU04">https://help.aliyun.com/document_detail/158047.html?spm=a2c4g.11186623.6.590.8e627c71tUMU04</a></p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h3 id="0-3d-升级和回滚应用"><a href="#0-3d-升级和回滚应用" class="headerlink" title="0.3d 升级和回滚应用"></a>0.3d 升级和回滚应用</h3><p>单批发布</p>
<p>分批发布</p>
<p>金丝雀发布</p>
<p>回滚应用</p>
<h3 id="0-5d-监控"><a href="#0-5d-监控" class="headerlink" title="0.5d 监控"></a>0.5d 监控</h3><p>*　应用总览<br>*　应用故障自动诊断<br>*　各种指标监控</p>
<h3 id="0-5d-应用运维"><a href="#0-5d-应用运维" class="headerlink" title="0.5d 应用运维"></a>0.5d 应用运维</h3><ul>
<li>自动缩扩容</li>
<li>发布回滚</li>
<li>查看历史版本</li>
<li>访问应用(暴露服务)</li>
<li>限流降级</li>
<li>日志查看</li>
<li>事件中心</li>
</ul>
<h3 id="0-2d-服务治理"><a href="#0-2d-服务治理" class="headerlink" title="0.2d 服务治理"></a>0.2d 服务治理</h3><ul>
<li><p>无损下线应用</p>
</li>
<li><p>金丝雀发布</p>
</li>
</ul>
<h3 id="0-1d-服务鉴权"><a href="#0-1d-服务鉴权" class="headerlink" title="0.1d 服务鉴权"></a>0.1d 服务鉴权</h3><h3 id="应用监控"><a href="#应用监控" class="headerlink" title="应用监控"></a>应用监控</h3><p> 参考 <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/152394.html?spm=a2c4g.11186623.6.648.7cc21f09yOmui9">https://help.aliyun.com/document_detail/152394.html?spm=a2c4g.11186623.6.648.7cc21f09yOmui9</a></p>
<h3 id="金丝雀发布"><a href="#金丝雀发布" class="headerlink" title="金丝雀发布"></a>金丝雀发布</h3><p>参考 <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/199071.html?spm=a2c4g.11186623.6.855.31d83cc1ZOiAbR">https://help.aliyun.com/document_detail/199071.html?spm=a2c4g.11186623.6.855.31d83cc1ZOiAbR</a></p>
<h3 id="0-5d-全链路压测"><a href="#0-5d-全链路压测" class="headerlink" title="0.5d 全链路压测"></a>0.5d 全链路压测</h3><h3 id="0-2d-链路追踪"><a href="#0-2d-链路追踪" class="headerlink" title="0.2d 链路追踪"></a>0.2d 链路追踪</h3><h3 id="0-2d-限流降级"><a href="#0-2d-限流降级" class="headerlink" title="0.2d 限流降级"></a>0.2d 限流降级</h3><h2 id="1d-文档整理输出"><a href="#1d-文档整理输出" class="headerlink" title="1d 文档整理输出"></a>1d 文档整理输出</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/EDAS%20%E8%AF%84%E4%BC%B0%E6%96%B9%E6%A1%88/" data-id="cld1bs9rw0000fynh0wj5e5ie" data-title="EDAS 评估方案" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/EDAS测试内容" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/EDAS%E6%B5%8B%E8%AF%95%E5%86%85%E5%AE%B9/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/EDAS%E6%B5%8B%E8%AF%95%E5%86%85%E5%AE%B9/">EDAS测试内容</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="EDAS测试内容"><a href="#EDAS测试内容" class="headerlink" title="EDAS测试内容"></a>EDAS测试内容</h1><h2 id="测试demo-准备"><a href="#测试demo-准备" class="headerlink" title="测试demo 准备"></a><strong>测试demo 准备</strong></h2><ol>
<li>准备 provide,consumer 两个Spring cloud demo 项目，准备测试服务调用</li>
<li>准备Springcloud demo 项目，增加正确调用接口<ul>
<li>测试调用链</li>
<li>测试服务鉴权</li>
<li>测试限流降级</li>
</ul>
</li>
<li>准备Springcloud demo 项目，增加错误调用接口 测试离群实例摘除策略</li>
</ol>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a><strong>部署</strong></h2><ol>
<li>ECS部署</li>
<li>K8s 部署</li>
</ol>
<ul>
<li>配置调度规则</li>
<li>配置启动命令</li>
<li>配置环境变量</li>
<li>配置持久化存储</li>
<li>配置本地存储</li>
<li>配置应用生命周期的钩子和探针</li>
<li>配置日志收集</li>
<li>配置Tomcat</li>
<li>配置Java启动参数</li>
<li>实现Ks集群应用的限流降级</li>
</ul>
<p>（添加公网SLB实现公网访问）</p>
<h2 id="升级和回滚应用"><a href="#升级和回滚应用" class="headerlink" title="升级和回滚应用"></a><strong>升级和回滚应用</strong></h2><ul>
<li>单批发布</li>
<li>分批发布</li>
<li>金丝雀发布</li>
<li>回滚应用</li>
</ul>
<p><strong>应用监控</strong></p>
<ul>
<li><p>查看应用总览</p>
</li>
<li><p>应用故障自动诊断</p>
</li>
<li><p>查看Prometheus监控指标</p>
</li>
<li><p>应用实例监控</p>
<ul>
<li>jvm监控</li>
<li>主机监控</li>
<li>Pod监控</li>
<li>SQL调用分析</li>
<li>NoSQL调用分析</li>
<li>异常分析</li>
<li>错误分析</li>
<li>上游应用</li>
<li>下游应用</li>
<li>调用链查询</li>
<li>日志</li>
<li>内存快照</li>
</ul>
</li>
<li><p>服务和接口监控</p>
</li>
<li><p>数据库调用监控</p>
</li>
<li><p>NoSQL调用</p>
</li>
<li><p>外部调用</p>
</li>
<li><p>MQ监控</p>
</li>
<li><p>应用诊断</p>
<ul>
<li>实时诊断</li>
<li>异常分析</li>
<li>线程分析</li>
<li>Arthas诊断</li>
<li>日志分析</li>
</ul>
</li>
<li><p>报警</p>
</li>
</ul>
<p><strong>应用运维</strong></p>
<ul>
<li>部署历史版本的应用</li>
<li>在部署过程中回滚应用</li>
<li>启停应用</li>
<li>访问应用(暴露服务)</li>
<li>应用缩扩容</li>
<li>限流降级</li>
<li>日志管理</li>
</ul>
<p><strong>服务治理</strong></p>
<ul>
<li>无损下线SPring Cloud 应用</li>
<li>金丝雀发布SpringCloud 应用</li>
<li>查询服务</li>
<li>查询调用链</li>
<li>使用离群实例</li>
<li>使用服务鉴权实现应用的访问控制</li>
<li>测试服务</li>
<li>压测服务</li>
<li>巡检服务</li>
<li>自动化回归服务测试用例</li>
<li>配置标签路由</li>
<li>配置服务降级</li>
<li>全链路流量控制</li>
</ul>
<h3 id="应用平台管理"><a href="#应用平台管理" class="headerlink" title="应用平台管理"></a>应用平台管理</h3><ul>
<li>权限管理</li>
<li>标签管理</li>
<li>配置管理</li>
</ul>
<p>关注点</p>
<ul>
<li>功能使用正常</li>
<li>实现方式(比如部署方式,无损下线应用,日志设计,离群实例)</li>
<li>做过哪些优化(比如在部署过程中回滚应用不产生垃圾数据,对生产环境影响最小,怎么无损下线应用)</li>
<li>平台架构(应用管理,资源管理,微服务治理,运维,系统管理)</li>
<li>可借鉴的功能(比如自动缩扩容,权限控制,流控规则管理等)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/EDAS%E6%B5%8B%E8%AF%95%E5%86%85%E5%AE%B9/" data-id="cld1bs9s10001fynheus551ln" data-title="EDAS测试内容" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/千方官网开发工作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E5%8D%83%E6%96%B9%E5%AE%98%E7%BD%91%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E5%8D%83%E6%96%B9%E5%AE%98%E7%BD%91%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C/">千方官网开发工作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="千方官网开发工作"><a href="#千方官网开发工作" class="headerlink" title="千方官网开发工作"></a>千方官网开发工作</h1><h2 id="后端方案"><a href="#后端方案" class="headerlink" title="后端方案"></a>后端方案</h2><ol>
<li>方案调研</li>
</ol>
<p>  1.1  开源产品</p>
<table>
<thead>
<tr>
<th>产品</th>
<th>项目地址</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>MCMS</td>
<td><a target="_blank" rel="noopener" href="https://gitee.com/mingSoft/MCMS">https://gitee.com/mingSoft/MCMS</a></td>
<td>系统成熟、流程完善、细节精致、使用简单。极低的成本投入，半分钟安装部署，选好模版一键导入； java 语言；自定义组件支持</td>
<td>付费(自定义组件)，bug较多</td>
</tr>
<tr>
<td>PublicCMS</td>
<td><a target="_blank" rel="noopener" href="https://gitee.com/sanluan/PublicCMS">https://gitee.com/sanluan/PublicCMS</a></td>
<td>java 语言；免费开源；架构科学；性能高</td>
<td>不支持自定义组件；兼容性差；界面老旧</td>
</tr>
<tr>
<td>ThinkJS</td>
<td><a target="_blank" rel="noopener" href="https://gitee.com/arterli/CmsWing">https://gitee.com/arterli/CmsWing</a></td>
<td>node 语言 前后端分离；界面美观，架构简单 易扩展；</td>
<td>不支持自定义组件；兼容性差；</td>
</tr>
<tr>
<td>Ms-server;Ms-client</td>
<td></td>
<td>自研CMS系统；易扩展；通用性强；易扩展；可配置性高</td>
<td>界面不美观，未商业化使用，bug较多；</td>
</tr>
</tbody></table>
<p>  1.2  自己开发</p>
<p>   开发时间长，投入开发人力成本大，出于上线周期的考虑不采用。</p>
<h1 id="所做工作"><a href="#所做工作" class="headerlink" title="所做工作"></a>所做工作</h1><h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><h3 id="前后端对接"><a href="#前后端对接" class="headerlink" title="前后端对接"></a>前后端对接</h3><h3 id="开源项目源码剖析"><a href="#开源项目源码剖析" class="headerlink" title="开源项目源码剖析"></a>开源项目源码剖析</h3><h3 id="开源项目改版"><a href="#开源项目改版" class="headerlink" title="开源项目改版"></a>开源项目改版</h3><ul>
<li><p>鉴权改版 ： </p>
<ul>
<li>破解开源项目鉴权方式；</li>
<li>增加软研特有鉴权方式。</li>
<li>返回结构改版</li>
<li>异常体系改版</li>
</ul>
</li>
<li><p>废除非必要异常体系，</p>
</li>
<li><p>前后端约定新版异常报警制度；</p>
</li>
<li><p>改版后端报警拦截策略</p>
</li>
<li><p>日志改版</p>
<ul>
<li>日志打印输出位置；</li>
<li>日志输出内容；</li>
<li>日志压缩方式；</li>
</ul>
</li>
<li><p>增加链路追踪</p>
</li>
</ul>
<h3 id="自定义组件开发"><a href="#自定义组件开发" class="headerlink" title="自定义组件开发"></a>自定义组件开发</h3><ul>
<li>使用MCMS 开源自定义组件编辑器开发，<ul>
<li>设计组件，</li>
<li>设计表，</li>
<li>导入源码，</li>
<li>故障 排查，</li>
<li>bug修复。</li>
</ul>
</li>
</ul>
<h3 id="真实数据配置"><a href="#真实数据配置" class="headerlink" title="真实数据配置"></a>真实数据配置</h3><ul>
<li>配置官网后台真实数据</li>
</ul>
<h3 id="原始官网数据库导入，数据转化"><a href="#原始官网数据库导入，数据转化" class="headerlink" title="原始官网数据库导入，数据转化"></a>原始官网数据库导入，数据转化</h3><ul>
<li>招聘信息数据转换</li>
<li>新闻富文本数据转换</li>
<li>静态资源 数据转换</li>
</ul>
<h3 id="文件服务器搭建，兼容原始静态资源服务器数据。"><a href="#文件服务器搭建，兼容原始静态资源服务器数据。" class="headerlink" title="文件服务器搭建，兼容原始静态资源服务器数据。"></a>文件服务器搭建，兼容原始静态资源服务器数据。</h3><h3 id="千方用户账号数据接入"><a href="#千方用户账号数据接入" class="headerlink" title="千方用户账号数据接入"></a>千方用户账号数据接入</h3><ul>
<li>LDAP用户数据接入</li>
<li>登录源码改版，适用于LDAP登录，登录验证。</li>
<li>用户账号初始权限分配，权限划分</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><ul>
<li>java-server项目部署</li>
<li>mysql 部署<h4 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h4> aliyun docker 部署<h4 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h4> 千方云主机中打镜像 -&gt;保存镜像文件-&gt;copy到aliyun主机-&gt;aliyun主机加载镜像 -&gt;重启</li>
</ul>
<h3 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h3><p>​    测试环境基础数据迁移到 aliyun环境；</p>
<p>​    测试环境 静态资源迁移到aliyun环境；</p>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><table>
<thead>
<tr>
<th>环境</th>
<th>地址</th>
<th>部署方式</th>
</tr>
</thead>
<tbody><tr>
<td>开发环境</td>
<td>localhost</td>
<td>主机部署</td>
</tr>
<tr>
<td>测试环境</td>
<td>172.20.;60.23</td>
<td>主机部署</td>
</tr>
<tr>
<td>生产环境</td>
<td>120.26.127.98</td>
<td>docker部署</td>
</tr>
</tbody></table>
<h1 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h1><ol>
<li>增加设计评审定稿过程，开发前设计方案定稿，避免开发过程中修改造成前后设计不一致推翻重做，造成资源浪费</li>
<li>新系统所需资料尽量开发前备齐。在开发过程中 很多页面的开发方式依赖于资源的提供情况，资源提供情况在开发过程中才确定，造成了时间浪费。</li>
<li>产品开发需提供原型，讨论内容形成文档，尽量避免口头需求。以免造成产品开发理解不一致。</li>
<li>后期官网尽量往自研后台方向扩展。原因：选择开源产品主要考虑时间成本，但后期会带来不易扩展，出bug 修复难度大，开源接口方案和自研设计接口方案不兼容，增加开发成本。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E5%8D%83%E6%96%B9%E5%AE%98%E7%BD%91%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C/" data-id="cld1bs9s30002fynhhfvjcik0" data-title="千方官网开发工作" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/每日一问0427(Redis)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/">每日一问0427(Redis)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="redis-简介"><a href="#redis-简介" class="headerlink" title="redis 简介"></a>redis 简介</h3><pre><code>     存在内存中，读写速度非常快，用于缓存，分布式锁，除此之外，redis 支持事务 、持久化、LUA脚本、LRU驱动事件、多种集群方案。
</code></pre>
<h3 id="redis-的线程模型"><a href="#redis-的线程模型" class="headerlink" title="redis 的线程模型"></a>redis 的线程模型</h3><pre><code>     redis 内部使用 文件事件处理器 file event handler ，这个处理器是单线程的，所以叫单线程模型。采用 IO多路复用机制同时监听多个socket ，根据socket 事件选择对应的事件处理器。
     test11
     文件事件处理器包括4部分:
     - 多个socket
     - IO多路复用程序
     - 文件事件分派器
     - 事件处理器(连接应答处理器/命令请求处理器/命令回复处理器)
     多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，会将 socket 产生的事件放入队列中排队，事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。
     ![avatar](https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png)
</code></pre>
<h3 id="为啥-redis-单线程模型也能效率这么高？"><a href="#为啥-redis-单线程模型也能效率这么高？" class="headerlink" title="为啥 redis 单线程模型也能效率这么高？"></a>为啥 redis 单线程模型也能效率这么高？</h3><pre><code>     - 纯内存操作
     - 核心是基于非阻塞的 IO 多路复用机制
     - 单线程反而避免了频繁的上下文切换
</code></pre>
<h3 id="redis-线程模型"><a href="#redis-线程模型" class="headerlink" title="redis 线程模型"></a>redis 线程模型</h3><pre><code>     内部使用 file event handler ，这个事件处理器是单线程的，所以 redis 单线程 模型，
     
     IO多路复用，同时监听多个socket
</code></pre>
<h3 id="redis-和-memcached-的区别"><a href="#redis-和-memcached-的区别" class="headerlink" title="redis 和 memcached 的区别"></a>redis 和 memcached 的区别</h3><pre><code>     - redis 支持更丰富的数据类型
     - redis 支持数据的持久化  ,memercache 重启丢失
     - 集群模式 保证高可用
     - memecached 多线程 非阻塞 IO复用 模型，redis 单线程 IO多路复用模型
</code></pre>
<h3 id="几种数据结构"><a href="#几种数据结构" class="headerlink" title="几种数据结构"></a>几种数据结构</h3><pre><code>     字符串String、字典Hash、列表List、集合Set、有序集合SortedSet。
     高级用法：
     - HyperLogLog 供不精确的去重计数功能，比较适合用来做大规模数据的去重统计，例如统计 UV；             
     - Bitmap 位图是支持按 bit 位来存储信息，可以用来实现 布隆过滤器（BloomFilter）；
     - GeoHash  可以用来保存地理位置，并作位置距离计算或者根据半径计算位置等。有没有想过用Redis来实现附近的人？
     - Pub/Sub 功能是订阅发布功能，可以用作简单的消息队列。
     - Pipeline    可以批量执行一组指令，一次性返回全部结果，可以减少频繁的请求应答。     
</code></pre>
<h3 id="pub-x2F-sub有什么缺点？"><a href="#pub-x2F-sub有什么缺点？" class="headerlink" title="pub&#x2F;sub有什么缺点？"></a>pub&#x2F;sub有什么缺点？</h3><pre><code>     在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如RocketMQ等。
</code></pre>
<h3 id="Zset-原理-跳跃表"><a href="#Zset-原理-跳跃表" class="headerlink" title="Zset 原理(跳跃表)"></a>Zset 原理(跳跃表)</h3><pre><code>     跳跃表性质如下：
     - 一个跳表由很多层组成
     - 每一层都是一个有序的链表
     - 最底层的链表(Level 1)包含所有的元素
     - 如果一个元素出现在Level i层的链表中，则在Level i层以下的所有层都将包含该元素
     - 每个节点包含key及其对应的value和一个指向同一层链表的下个节点的指针数组
</code></pre>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><pre><code>     Redis 提供了 RDB 和 AOF 两种持久化方式，RDB是将全量数据集以快照形式写入磁盘，实际上是通过fork 子进程执行,采用二进制压缩存储;AOF以分别日志形式记录 redis 增量，  内存   
</code></pre>
<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><pre><code>     哨兵(3个选举)+ 主从(RDB+AOF)
</code></pre>
<h3 id="如何保证-缓存数据库双写数据一致性"><a href="#如何保证-缓存数据库双写数据一致性" class="headerlink" title="如何保证 缓存数据库双写数据一致性"></a>如何保证 缓存数据库双写数据一致性</h3><pre><code>     - 弱一致性 ，定时任务
     - 强一致性 ，串行化 ，但会影响性能
</code></pre>
<h3 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h3><pre><code>     - 主从
     - 哨兵（Sentinel）: 是一个集群，监控redis 节点，每隔一秒向master发送ping,如果再一段时间内收不到pong，则认为master 下线
     - cluster 集群部署 :采用去中心化的思想;它采用一定方式，在集群中分布存储;节点之间采用轻量协议通讯，减少带宽占用；自动实现负载均衡与高可用，自动实现 failover并且支持动态扩展；内部也需要配置主从，并且内部也是采用哨兵模式，如果集群中master没有slave节点，则master挂掉整个集群进入fail状态，因为集群slot映射补全，如果超过半数master挂掉也会进入fail
</code></pre>
<h3 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h3><pre><code>     - 数据copy 从服务器接收同步命令，同步主服务器数据
     - 命令传播， 主服务器接收一条消息，发出同步命令，从服务器同步该条数据。
     2.8 之前 只要断线 就要复制 ，2.8 之后短时断线 从服务器根据偏移量部分重同步
</code></pre>
<p>​<br>​         <a target="_blank" rel="noopener" href="https://www.cnblogs.com/liyan492/p/9858548.html">redisson,jedis,Lettuce 三者的区别</a><br>​     理器&#x2F;命令请求处理器&#x2F;命令回复处理器)<br>​     多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，会将 socket 产生的事件放入队列中排队，事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。<br>​     <img src="https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png" alt="avatar"></p>
<h3 id="BloomFilter-原理"><a href="#BloomFilter-原理" class="headerlink" title="BloomFilter 原理"></a>BloomFilter 原理</h3><p>当一个元素被加入集合时，通过K个散列函数将这个元素映射成一个位数组中的K个点，把它们置为1。检索时，我们只要看看这些点是不是都是1就（大约）知道集合中有没有它了：如果这些点有任何一个0，则被检元素一定不在；如果都是1，则被检元素很可能在。这就是布隆过滤器的基本思想。</p>
<h3 id="Redis的过期策略"><a href="#Redis的过期策略" class="headerlink" title="Redis的过期策略"></a>Redis的过期策略</h3><ul>
<li>定期随机删除</li>
<li>惰性删除</li>
<li>内存淘汰 （（volatile-lru 尝试回收最少使用的键），LRU算法）</li>
</ul>
<h2 id="压缩列表"><a href="#压缩列表" class="headerlink" title="压缩列表"></a>压缩列表</h2><p>​    </p>
<h3 id="缓存雪崩和穿透的解决方案"><a href="#缓存雪崩和穿透的解决方案" class="headerlink" title="缓存雪崩和穿透的解决方案"></a>缓存雪崩和穿透的解决方案</h3><p>####缓存雪崩</p>
<p>同一时间缓存大面积失效，后面请求落到数据库上。</p>
<p>解决方法</p>
<ul>
<li>事前: 保证 redis 集群高可用性，发现宕机尽快补上。选择合适的内存淘汰策略</li>
<li>事中: 本地 ehcache缓存+ hystrix 限流&amp; 降级 ,避免 MySql 崩掉</li>
<li>事后： 利用 redis 持久化机制 保存的数据尽快恢复缓存</li>
</ul>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>热点key 不在缓存中，导致请求直接到了 数据库上，</p>
<p>解决方法</p>
<ul>
<li>缓存无效key 设置过期时间尽量短</li>
<li>布隆过滤器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当一个元素加入布隆过滤器中的时候，会进行如下操作：</span><br><span class="line">   </span><br><span class="line">   使用布隆过滤器中的哈希函数对元素值进行计算，得到哈希值（有几个哈希函数得到几个哈希值）。</span><br><span class="line">   根据得到的哈希值，在位数组中把对应下标的值置为 1。</span><br><span class="line">   当我们需要判断一个元素是否存在于布隆过滤器的时候，会进行如下操作：</span><br><span class="line">   </span><br><span class="line">   对给定元素再次进行相同的哈希计算；</span><br><span class="line">   得到值之后判断位数组中的每个元素是否都为 1，如果值都为 1，那么说明这个值在布隆过滤器中，如果存在一个值不为 1，说明该元素不在布隆过滤器中。</span><br></pre></td></tr></table></figure>
<h2 id="如何部署高可用的Redis集群架构"><a href="#如何部署高可用的Redis集群架构" class="headerlink" title="如何部署高可用的Redis集群架构"></a>如何部署高可用的Redis集群架构</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangshulang1234/article/details/78765308">如何部署高可用的Redis集群架构</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liyan492/p/9858548.html">redisson,jedis,Lettuce 三者的区别</a></p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>批量删除 测试<br>k run –namespace devops redis-client –rm –tty -i –restart&#x3D;’Never’ –image 172.20.60.16:5000&#x2F;library&#x2F;redis:5.0.5-alpine –command – redis-cli -h devops-redis-redis-ha   -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<p>redis-cli    -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<p>redis-cli  -a redis@2020  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a redis@2020 del</p>
<p>redis-cli  -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunternet/p/11306690.html">压缩列表</a></p>
<p>[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jelly12345/p/15223184.html">Redis写时拷贝（COW）总结</a>]</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/" data-id="cld1bs9s40003fynh3anpazdr" data-title="每日一问0427(Redis)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/每日一问0428(Springbean初始化过程)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0428(Springbean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0428(Springbean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B)/">每日一问0428(Springbean初始化过程)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<h1 id="Spring-bean-初始化过程"><a href="#Spring-bean-初始化过程" class="headerlink" title="Spring bean 初始化过程"></a>Spring bean 初始化过程</h1><p>问题</p>
<ul>
<li>1.bean 是如何被初始化 在 IOC容器中的</li>
<li>2.bean 是如何销毁的</li>
<li>3.bean 初始化后保存在哪</li>
<li>4.bean bean 怎么延迟初始化的</li>
<li>5.通过main 方法怎么实现一个 bean</li>
</ul>
<p>在理解任何技术之前，我都会问自己一个问题：它的产生是为了解决什么样的问题，以及如何解决这些问题？希望你能在本篇文章中找到答案……</p>
<h3 id="怎么将自己的对象注入Spring"><a href="#怎么将自己的对象注入Spring" class="headerlink" title="怎么将自己的对象注入Spring"></a>怎么将自己的对象注入Spring</h3><ul>
<li>@bean</li>
<li>ApplicationContext.beanFactory.register…</li>
<li>FactoryBean 注入对象 生成defination 放入 map（BeanDefinationMap里增加自己对象的class）</li>
</ul>
<p><code>classLoader 加载有注解的类 ，生成 define,放入BeanDefinationMap,当用到的时候，从define 查找，拿出来初始化。</code></p>
<p>知识点收集：</br><br>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;#160;上面的生命周期流程图，时候的时候注意调用先后顺序，避免属性被覆盖的现象。</p>
<ul>
<li>BeanFactoryPostProcessor 主要是在Spring刚加载完配置文件，还没来得及初始化Bean的时候做一些操作。比如篡改某个Bean在配置文件中配置的内容。</li>
<li>InstantiationAwareBeanPostProcessorAdapter 基本没什么鸟用，Bean初始化后，还没有设置属性值时调用，和BeanFactoryPostProcessor一样，可以篡改配置文件加载到内存中的信息。 </li>
<li>ApplicationContextAware:用处很大，注入了ApplicationContext到Bean中。</li>
<li>InitializingBean:有用处，可以在Bean属性全部改完之后，再做一些定制化操作。</li>
<li>BeanPostProcessor：没什么用，Spring框架内部使用的比较猛，像什么AOP，动态代理，都是在这搞事。后期有时间和大家分析。</li>
<li>其他的像什么init-method，destroy方法，基本都是个摆设。。我是没怎么用过，只知道有这么回事。</li>
</ul>
<p><strong>问：?ApplicationContextAware:用处很大，注入了ApplicationContext到Bean中。   ApplicationContext 是啥</strong></p>
<p>  【Spring】BeanFactory 解析 bean 详解 <a target="_blank" rel="noopener" href="https://juejin.im/post/5b9f707ce51d450e3f6b8244">https://juejin.im/post/5b9f707ce51d450e3f6b8244</a><br>    1.XmlBeanFactory 加载 bean  这是初级操作， 在企业开发中一般是使用功能更完善的 ApplicationContext</p>
<p>XmlBeanFactory 的实现 ：<br>  实现了 DefaultListableBeanFactory 	，他是注册加载bean 的默认实现，是bean加载的核心部分。<br>  XmlBeanFactory 不同的是 替换了自定义的 xml 读取器</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/593386ca2f301e00584f8036">https://juejin.im/post/593386ca2f301e00584f8036</a></p>
</blockquote>
<p>顺便增加了 对IOC的理解，<strong>就是叫你不用去管对象的生命周期，而关注到对象的使用上</strong></br><br>IOC 常用的有两种方式：</p>
<blockquote>
<p>构造方法注入和setter注入</p>
</blockquote>
<p>ApplicationContext 容器 ，可以认为是BeanFactory的一种扩展。</p>
<ul>
<li>BeanFactory 默认采用延迟 初始化策略( lazy-load)  ?还有啥初始化策略，</li>
<li>BeanDefinition Bean生成 Bean定义的地方  （读取配置 reader 读取 ，property 读取 ，然后生成对象相关的定义，并未真正初始化）</li>
<li>BeanDefinitionRegistry bean的注册中心 （将对象的定义 注册上）（注册的时候 会生成一个注册码）</li>
<li>BeanFactory 可以取到任意定义过的Bean  （对象的出口，有就拿走，没有就生成）</li>
</ul>
<h2 id="对象的初始化"><a href="#对象的初始化" class="headerlink" title="对象的初始化"></a>对象的初始化</h2><p>初始是通过 beanFactory的 getBean()时才进行的。</p>
<ul>
<li>对象不是new出来的 其实这里用到了AOP机制，生成了其代理对象，通过 反射机制 生成接口对象，或者是通过CGLIB生成子对象</li>
<li>beanWrapper 实现了bean 具体装载过程（它继承了PropertyAccessor （可以对属性进行访问）、PropertyEditorRegistry 和TypeConverter接口 （实现类型转换））</li>
<li>BeanPostprocessor 可以帮助 初始化之前和之后的完成一些必要工作 ，比如 参数解密。</li>
<li>在完成postProcessor 之后，则会看对象是否定义了InitializingBean 接口  或者 spring还提供了另外一种指定初始化的方式，即在bean定义中指定init-method 。</li>
</ul>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>ApplicationContext 拥有BeanFactory的所有功能，但应用方法略有不同</p>
<ul>
<li><p>bean的加载方式</p>
</li>
<li><p>BeanFactory提供BeanReader来从配置文件中读取bean配置。相应的ApplicationContext也提供几个读取配置文件的方式 xxxxxxreader.xml</p>
</li>
<li><p>ApplicationContext采用的非懒加载方式 	它会在启动阶段完成所有的初始化，并不会等到getBean()才执行。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0428(Springbean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B)/" data-id="cld1bs9s50004fynh37zrhz29" data-title="每日一问0428(Springbean初始化过程)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/每日一问0430(Spring boot 启动篇)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0430(Spring%20boot%20%E5%90%AF%E5%8A%A8%E7%AF%87)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0430(Spring%20boot%20%E5%90%AF%E5%8A%A8%E7%AF%87)/">每日一问0430(Spring boot 启动篇)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring-boot-启动篇"><a href="#Spring-boot-启动篇" class="headerlink" title="Spring boot 启动篇"></a>Spring boot 启动篇</h1><h2 id="Spring-中的概念"><a href="#Spring-中的概念" class="headerlink" title="Spring 中的概念"></a>Spring 中的概念</h2><h3 id="1-BeanDefinition"><a href="#1-BeanDefinition" class="headerlink" title="1.BeanDefinition"></a>1.BeanDefinition</h3><p>描述Bean的信息，配置Bean的方式有三种:</p>
<ul>
<li>XML 配置文件</li>
<li>Java 注解 @Service,@Component</li>
<li>Java Config  注入Bean</li>
</ul>
<p>Spring 在启动时，会将Bean配置信息加载成BeanDefintion对象</p>
<h3 id="2-BeanDefinitionRegistry"><a href="#2-BeanDefinitionRegistry" class="headerlink" title="2.BeanDefinitionRegistry"></a>2.BeanDefinitionRegistry</h3><p>是BeanDefination的容器，所有BeanDefination 都会注册到这个对象中。<br>可以通过Spring的扩展机制往Registry中注册 BeanDefination对象</p>
<h3 id="3-BeanFactory"><a href="#3-BeanFactory" class="headerlink" title="3.BeanFactory"></a>3.BeanFactory</h3><p>Bean 工厂，负责Bean的创建和属性注入。同时他也是个Bean的容器，通过BeanDefination对象创建Bean实例，<code>所有的单例Bean都会注册到BeanFactory 中。</code></p>
<h3 id="4-BeanFactoryProcessor"><a href="#4-BeanFactoryProcessor" class="headerlink" title="4.BeanFactoryProcessor"></a>4.BeanFactoryProcessor</h3><p>Spring 提供的扩展机制，用于在所有Bean配置信息解析完成后修改Bean工厂信息。解析所有Bean完成之后，<code>会调用所有BeanFactoryPostProcessor实现类的postProcessBeanFactory()方法。</code></p>
<h3 id="5-importBeanDefinationRegistor"><a href="#5-importBeanDefinationRegistor" class="headerlink" title="5. importBeanDefinationRegistor"></a>5. importBeanDefinationRegistor</h3><p>在定义容器中注入定义的一个东西。该接口的实现类作用于Spring解析Bean的配置阶段，当解析@Configuration注解时，可以通过ImportBeanDefinitionRegistrar接口的实现类想，Bean定义的容器(BeanDefinitionRegistry)中，添加BeanDefinition对象。</p>
<p>ImportBeanDefinitionRegistrar接口实现类的registerBeanDefinitions()方法会在Spring解析@Configuration注解时调用。ImportBeanDefinitionRegistrar接口需要配合@Import注解使用，importingClassMetadata参数为@Import所在注解的配置信息，registry参数为BeanDefinition容器。</p>
<h3 id="6-BeanPostProcessor"><a href="#6-BeanPostProcessor" class="headerlink" title="6.BeanPostProcessor"></a>6.BeanPostProcessor</h3><p>Bean 初始化方法调用前后，会执行Processor中定义的拦截逻辑。</p>
<ul>
<li>postProcessBeforeInitialization() 初始化之前</li>
<li>postProcessAfterInitialization() 初始化之后</li>
</ul>
<h3 id="7-ClassPathBeanDefinationScanner"><a href="#7-ClassPathBeanDefinationScanner" class="headerlink" title="7.ClassPathBeanDefinationScanner"></a>7.ClassPathBeanDefinationScanner</h3><p>是BeanDefination扫描器，能够对指定包下的Class进行自定义扫描，将Class信息转换为BeanDefination注册到BeanDefinationRegistry容器中。</p>
<h3 id="8-FactoryBean"><a href="#8-FactoryBean" class="headerlink" title="8.FactoryBean"></a>8.FactoryBean</h3><p>不能作为普通Bean使用，而是作为单个对象的工厂。当通过Bean名称获取FactoryBean 实例时，实际是getObject()返回的。获得自定义的Bean，OpenFeign就是用这个来实现的。   </p>
<h2 id="Spring-容器启动过程"><a href="#Spring-容器启动过程" class="headerlink" title="Spring 容器启动过程"></a>Spring 容器启动过程</h2><p><img src="/../../ImgSource/WX20200430-175633.png" alt="avatar"></p>
<ol>
<li>解析所有Bean配置信息，生成BeanDefination对象，并注册到Registory.</li>
<li>先实例化实现了BeanFactoryPostProcessor接口的Bean（从容器中找出来实例化，）然后在postProcessBeanFactory()中<code>可以对Bean工厂信息进行修改</code>。</li>
<li>再实例化所有单例Bean，并对其属性进行填充</li>
<li>执行 before </li>
<li>初始化bean</li>
<li>执行after</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0430(Spring%20boot%20%E5%90%AF%E5%8A%A8%E7%AF%87)/" data-id="cld1bs9s60005fynhdew5deeg" data-title="每日一问0430(Spring boot 启动篇)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/每日一问0506(Spring boot 熔断)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0506(Spring%20boot%20%E7%86%94%E6%96%AD)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0506(Spring%20boot%20%E7%86%94%E6%96%AD)/">每日一问0506(Spring boot 熔断)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring-boot-熔断"><a href="#Spring-boot-熔断" class="headerlink" title="Spring boot 熔断"></a>Spring boot 熔断</h1><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY"></a>WHY</h2><p> 今天遇到一个线上问题，在发送 fengin 请求时，偶发一个问题 <code>could not be queued for execution and no fallback available.</code> 查了一下 发现是fegin 队列不够了。</p>
<h4 id="问题来了"><a href="#问题来了" class="headerlink" title="问题来了"></a>问题来了</h4><ol>
<li>为啥会队列不够，队列默认多少，怎么加入的队列 </li>
<li>怎个问题咋解决</li>
<li>关于熔断会不会有其他坑</li>
</ol>
<p> 遇到问题首先想到的肯定是如何去解决，我也一样，开始百度一下，很简单找到了答案，增加一段hystrix 配置   </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0506(Spring%20boot%20%E7%86%94%E6%96%AD)/" data-id="cld1bs9s70006fynheui51fhj" data-title="每日一问0506(Spring boot 熔断)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019/每日一问0708(建表规范)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0708(%E5%BB%BA%E8%A1%A8%E8%A7%84%E8%8C%83)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0708(%E5%BB%BA%E8%A1%A8%E8%A7%84%E8%8C%83)/">每日一问0708(建表规范)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="建表规范"><a href="#建表规范" class="headerlink" title="建表规范"></a>建表规范</h1><ol>
<li><p>【强制】表达是与否概念的字段，必须使用 xxx_flag 的方式命名，数据类型是 unsigned tinyint（1 表示是， 0 表示否）。<br>说明： 使用 xxx_flag 的方式而不是is_xxx的方式，避免一些公共框架使用get、set方式反射机制的时候出现问题。<br>正例： 表达逻辑删除的字段名 delete_flag， 1 表示删除， 0 表示未删除。</p>
</li>
<li><p>【强制】禁用保留字，如 desc、 range、 match、 delayed 等， 请参考 MySQL 官方保留字。<br>说明：可以组合其他实体信息与关键字一起使用。例如表达活动描述，可以使用字段名：activity_desc</p>
</li>
<li><p>【强制】 主键索引名为 pk_字段名； 唯一索引名为 uk_字段名； 普通索引名则为 idx_字段名。<br>说明： pk_ 即 primary key； uk_ 即 unique key； idx_ 即 index 的简称。<br>正例： pk_id，uk_user_id，idx_create_time</p>
</li>
</ol>
<p>primary key pk_id(id),<br>unique key uk_user_id(user_id)</p>
<ol start="9">
<li>【强制】表必备三字段： id,create_time, update_time。<br>说明： 其中 id 必为主键，类型为 unsigned bigint、单表时自增、步长为 1。 create_time,update_time 的类型均为 date_time 类型。<br>正例：</li>
</ol>
<p>id bigint unsigned not null auto_increment comment ‘主键’,<br>……<br>create_time datetime not null default current_timestamp comment ‘创建时间’,<br>update_time datetime not null default current_timestamp on update current_timestamp comment ‘更新时间’</p>
<ol start="11">
<li><p>【推荐】库名与应用名称尽量一致。<br>说明：微服务单独使用一个库的时候尽量与应用名称一致，与其他微服务共用数据库实例的时候可以不遵循该规约。</p>
</li>
<li><p>【强制】除了 text、blob 类型，所有字段设置为not null，设置default值。<br>说明：所有字段设置为not null带来一定的成本，需要避免insert或者update的时候出现错误，例如：insert into xxx(col1,col2) values(‘1’, null)或者update xxx set col1&#x3D;null。但是字段存在null值产生更多问题：1）null与任何值的直接比较都为null，例如：null!&#x3D;null 不是返回false，判断需要采用is null操作符；2）sum函数对于字段全为null的情况返回null而不是0，对于返回可能存在NPE；3）对于查询出来的记录，处理不当容易NPE；4）存在null的列难以查询优化；5）联表查询的时候null值代表的意思模糊，join的null值代表不存在对应记录；</p>
</li>
<li><p>【补充】整型类型的字段，如果非负请使用unsigned<br>说明：无符号值可以避免误存负数， 且扩大了表示范围</p>
</li>
</ol>
<p>（二）索引规约<br>2. 【强制】超过三个表禁止 join。需要 join 的字段，数据类型必须绝对一致； 多表关联查询时，<br>保证被关联的字段需要有索引。<br>说明： 即使双表 join 也要注意表索引、 SQL 性能。</p>
<ol start="4">
<li>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。<br>说明： 索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索<br>引</li>
</ol>
<p>（三）SQL语句</p>
<ol>
<li><p>【强制】不要使用 count(列名)或 count(常量)来替代 count(<em>)， count(</em>)是 SQL92 定义的标准统计行数的语法。<br>说明： count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。</p>
</li>
<li><p>【强制】不得使用外键与级联，一切外键概念必须在应用层解决。<br>说明：以学生和成绩的关系为例，学生表中的 student_id 是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新， 即为级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群； 级联更新是强阻塞，存在数据库更新风暴的风险； 外键影响数据库的插入速度。</p>
</li>
<li><p>【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p>
</li>
</ol>
<p>（四）ORM映射</p>
<ol>
<li><p>【强制】在表查询中，一律不要使用 * 作为查询的字段列表，需要哪些字段必须明确写明。<br>说明： 1） 增加查询分析器解析成本。 2） 增减字段容易与 resultMap 配置不一致。</p>
</li>
<li><p>【强制】sql.xml 配置参数使用： #{}， #param# 不要使用${} 此种方式容易出现 SQL 注入。</p>
</li>
<li><p>【强制】 iBATIS 自带的 queryForList(String statementName,int start,int size)不推荐使用。<br>说明：其实现方式是在数据库取到 statementName对应的SQL语句的所有记录，再通过 subList取 start,size 的子集合。因此，建议自己在SQL中指定 limit start,size ，通过传参执行SQL<br>正例：</p>
</li>
</ol>
<p>Map&lt;String, Object&gt; map &#x3D; new HashMap&lt;String, Object&gt;();<br>map.put(“start”, start);<br>map.put(“size”, size);</p>
<ol start="8">
<li>【推荐】不要写一个大而全的数据更新接口。 传入 POJO 类，进行 update table set c1&#x3D;value1,c2&#x3D;value2,c3&#x3D;value3; 这是不对的。<br>说明：不要更新无改动的字段，一是易出错； 二是效率低； 三是增加 binlog 存储。针对一张表的业务逻辑编写多个更新SQL。<br>正例：例如更新订单状态：update order_info set status&#x3D;value1 where xxx</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0708(%E5%BB%BA%E8%A1%A8%E8%A7%84%E8%8C%83)/" data-id="cld1bs9s80007fynh3o4h9593" data-title="每日一问0708(建表规范)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/13/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/15/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/2019/">2019</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2020/">2020</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2021/">2021</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2022/">2022</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/">学习英语</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/">快速通道</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%91%84%E5%BD%B1/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E4%B9%90/">音乐</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0922(%E6%9E%B6%E6%9E%84)/">每日一问0922(架构)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2022/%E8%BF%B0%E8%81%8C%E6%A8%A1%E6%9D%BF/">述职模板</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/%E8%8B%B1%E6%96%87%E5%8D%95%E8%AF%8D%E7%A7%AF%E7%B4%AF/">英文单词积累</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/%E5%A5%BD%E7%8E%A9%E7%9A%84%E5%9C%B0%E5%9D%80/">好玩的地址</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E6%91%84%E5%BD%B1/%E6%91%84%E5%BD%B1%E5%90%8E%E6%9C%9F/">摄影后期</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>