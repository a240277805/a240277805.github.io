<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>每日一问0701(布隆过滤器) | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="布隆过滤器(Bloom Filter)你好，我叫孟康。  晚上和朋友开黑，他用的布隆，操作carry全场，不过我说的这个布隆的格挡技术不亚于这个英雄。  先来讲一个香皂盒的故事。  联合利华引进了一条香皂包装生产线，结果发现这条生产线有个缺陷：常常会有盒子里没装入香皂。总不能把空盒子卖给顾客啊，他们只得请了一个学自动化的博士后设计一个方案来分拣空的香皂盒。博士后拉起了一个十几人的科研攻关小组，综合">
<meta property="og:type" content="article">
<meta property="og:title" content="每日一问0701(布隆过滤器)">
<meta property="og:url" content="https://a240277805.github.io/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0701(%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="布隆过滤器(Bloom Filter)你好，我叫孟康。  晚上和朋友开黑，他用的布隆，操作carry全场，不过我说的这个布隆的格挡技术不亚于这个英雄。  先来讲一个香皂盒的故事。  联合利华引进了一条香皂包装生产线，结果发现这条生产线有个缺陷：常常会有盒子里没装入香皂。总不能把空盒子卖给顾客啊，他们只得请了一个学自动化的博士后设计一个方案来分拣空的香皂盒。博士后拉起了一个十几人的科研攻关小组，综合">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://bkimg.cdn.bcebos.com/pic/7acb0a46f21fbe09b5f6ad4467600c338744ad32?x-bce-process=image/crop,x_125,y_0,w_1087,h_717/watermark,g_7,image_d2F0ZXIvYmFpa2UxNTA=,xp_5,yp_5">
<meta property="og:image" content="https://a240277805.github.io/ImgSource/bulong_bitmap.png">
<meta property="article:published_time" content="2023-01-18T07:13:14.734Z">
<meta property="article:modified_time" content="2023-01-18T07:13:14.734Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bkimg.cdn.bcebos.com/pic/7acb0a46f21fbe09b5f6ad4467600c338744ad32?x-bce-process=image/crop,x_125,y_0,w_1087,h_717/watermark,g_7,image_d2F0ZXIvYmFpa2UxNTA=,xp_5,yp_5">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://a240277805.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2020/每日一问0701(布隆过滤器)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0701(%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:13:14.734Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2020/">2020</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      每日一问0701(布隆过滤器)
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="布隆过滤器-Bloom-Filter"><a href="#布隆过滤器-Bloom-Filter" class="headerlink" title="布隆过滤器(Bloom Filter)"></a>布隆过滤器(Bloom Filter)</h1><p><img src="https://bkimg.cdn.bcebos.com/pic/7acb0a46f21fbe09b5f6ad4467600c338744ad32?x-bce-process=image/crop,x_125,y_0,w_1087,h_717/watermark,g_7,image_d2F0ZXIvYmFpa2UxNTA=,xp_5,yp_5" alt="avatar"><br>你好，我叫孟康。</p>
<p> 晚上和朋友开黑，他用的布隆，操作carry全场，不过我说的这个布隆的格挡技术不亚于这个英雄。</p>
<p> 先来讲一个香皂盒的故事。</p>
<p> 联合利华引进了一条香皂包装生产线，结果发现这条生产线有个缺陷：常常会有盒子里没装入香皂。总不能把空盒子卖给顾客啊，他们只得请了一个学自动化的博士后设计一个方案来分拣空的香皂盒。博士后拉起了一个十几人的科研攻关小组，综合采用了机械、微电子、自动化、X射线探测等技术，花了几十万，成功解决了问题。每当生产线上有空香皂盒通过，两旁的探测器会检测到，并且驱动一只机械手把空皂盒推走。<br>  中国南方有个乡镇企业也买了同样的生产线，老板发现这个问题后大为发火，找了个小工来说:你他妈给老子把这个搞定，不然你给老子爬出去。小工很快想出了办法：他在生产线旁边放了台风扇猛吹，空皂盒自然会被吹走。</p>
<p> 其实做软件开发的时候我们也会遇到很多类似的情况。</p>
<h2 id="解决啥问题"><a href="#解决啥问题" class="headerlink" title="解决啥问题"></a>解决啥问题</h2><p>  我们的应用通常可以抽象成三部分，由请求处理、计算逻辑和数据存取三部分。根据性能瓶颈的侧重点不同，偏向计算逻辑<br>的 叫<code>CPU密集型</code>应用，数据存取逻辑的是<code>IO密集型</code>。所以以前我在考虑架构优化的侧重点也就在计算逻辑，和数据存取最多。<br>这种优化的方式 往往是从CPU计算的结构算法复杂度，或者是数据存储的类型，减少磁盘操作等等的优化。这些都是偏向于技术方面的。</p>
<p>但是从业务角度出发，往往有些场景，用特定的手段可以取到意想不到的效果。</p>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><p> 比如查询用户的信息，有些用户可能并不存在，那我们可能把基本信息查询放在了最前边(代码的第一行)，如果不存在就直接返回，就会避免后边的数据拼接和其他的IO查询。<br>但是一个用户基本信息的数据库查询 还是会走一次IO。</p>
<p>在生产环境中，往往我们会对一些热点用户信息做缓存，但是也免不了恶意用户，抓住漏洞，大量请求不存在的用户信息，这些用户不存在缓存中，全部走磁盘IO 会给数据库带来非常大的压力。也就是造成了<code>缓存击穿</code></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li>回写空值</li>
<li>过滤器</li>
</ul>
<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>可以在最外层根据用户ID 做一层缓存，把所有用户信息都放到缓存层，请求进来先经过缓存，发现没有该用户，则直接返回，那所有用户ID的缓存需要的空间应该会不少吧。</p>
<h4 id="内存计算"><a href="#内存计算" class="headerlink" title="内存计算"></a>内存计算</h4><p>为了方便计算内存占用，先来回顾一下 计算机存储的基础知识。</p>
<ul>
<li><p>1KB&#x3D;1024字节</p>
</li>
<li><p>1024K&#x3D;1M</p>
</li>
<li><p>1024M&#x3D;1G</p>
</li>
<li><p>一个字节(KB)占8位</p>
</li>
<li><p>char是 2个字节 16位，char 最大值 65535</p>
</li>
<li><p>int 是4 个字节 32位 int 最大值 2147483647</p>
</li>
</ul>
<h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><p>如果我们的数据量是千万级以内，我们可以用哈希表，利用hashMap 的的一些优势，碰撞扩容，拉链法解决冲突，然后演变红黑二叉树等等。我们甚至可以记录出现次数等额外信息。</p>
<h3 id="连续数组"><a href="#连续数组" class="headerlink" title="连续数组"></a>连续数组</h3><p>但是如果我们有一亿的用户量。将用户的信息放到缓存，还要支持快速查找，该怎么处理呢？</p>
<p>快速查找的方案有很多，比如放到数组里排好序，每个指针指向一个ID，二分法查找 ，时间复杂度 log n,<br>用什么数据结构存储呢，我们都知道 char 的取值范围是65535，所以最少要用int （最大2147483647）， int 是32位，4个字节，一亿个ID 耗费的内存就是 4亿&#x2F;1000&#x2F;1000 &#x3D;400M，（大约估算）</p>
<h3 id="位图BitMap"><a href="#位图BitMap" class="headerlink" title="位图BitMap"></a>位图BitMap</h3><p>有没有更好的方法呢，再来分析一下我们的业务需求，要判断某个用户ID在一亿个数的集合中是否存在，先来分析用户的ID的取值范围，如果用int定义的用户ID的话，那最大是21 4748 3647，二十亿的大小，<br>我们可以开辟一个 20亿（大约）个连续内存空间，每一个空间表示一个用户ID，属性只有存在 和不存在,我们使用最小的内存 bit(位)(0:不存在，1:存在)存储<br>这样的内存大小就是 20亿&#x2F;8 &#x2F;1000&#x2F;1000&#x3D;250M,而查找效率都用下标指针取值，一次取值 n1 就可以，这种方案明显就比上边的方案要好。(真的好吗？)</p>
<p>怎么来实现呢。这个时候我们的问题就变成了 怎么用最小的内存空间bit(位)来标记一个数字。下来我们就用到了 <code>位图</code>的结构。</p>
<p>位图：数据结构</p>
<p> 内部维护数组   char [M] [N];</p>
<p> 位图在内部维护了一个M×N维的数组char[M][N]，在这个数组里面每个字节占8位，因此可以存储M×N×8个数据。假如要存储的数据范围为0～15，则只需使用M&#x3D;1, N&#x3D;2的数据进行存储。<br> 在我们要存储的数据为{1,3,6,10,15}时，只需将有数据的位设置为1，表示该位存在数据，将其他位设置为0 ，如图所示<br> <img src="/../../ImgSource/bulong_bitmap.png" alt="avatar"></p>
<p> 具体为啥要用char ，我也不知道。 存40亿 位的数 大概需要 40亿&#x2F;8&#x2F;M&#x2F;&#x3D;N 的大小</p>
<p> 然后来看看 怎么初始化 ？怎么设置值？怎么取值？</p>
<h4 id="位操作"><a href="#位操作" class="headerlink" title="位操作"></a>位操作</h4><p> 这里会涉及到一些位操作 </p>
<ul>
<li>&amp; : 0&amp;1&#x3D;0 ，0&amp;0&#x3D;0，1&amp;1&#x3D;1</li>
<li>| : 0|1&#x3D;1，0|0&#x3D;0，1|1&#x3D;1</li>
<li><code>&lt;&lt;</code> : 左移，高位舍去，如果高位舍去的是零相当于乘以2的N(左移位数)次， 1&lt;&lt;3 就是 0000 0001 变成 0000 1000 </li>
<li><code>&gt;&gt;</code> : 右移，低位舍去，如果低位舍去的是零相当于除以2的N(右移位数)次， 7&gt;&gt;3 就是 1111 1111 变成 0001 1111</li>
</ul>
<p> 位图中设置一个值也就是要设置一个char(16位)中的一位，要用到位运算  <code>a|1&lt;&lt;n</code> a代表原来的char ,n 代表第几位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  我们想设置char 中某一位 为1,可以与该位为1其他位都是0的一个二进制进行或运算</span><br><span class="line">比如: 0000 0001 中想设置第三位 为1 则 用0000 1000 | 0000 0001=0000 1001</span><br><span class="line"></span><br><span class="line">怎么得到某一位为1 其他位都是0 的数 可以用 1&lt;&lt; 左移，</span><br><span class="line">1=0000 0001 </span><br><span class="line">1&lt;&lt;3=000 1000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p> 这样实现基本的用位图过滤就实现了，那我们再深入了解一下需求，如果我们的ID不是连续的 而是非常<code>离散稀疏</code>的呢，举个极端的例子 比如我们只有少量用户 ，一个ID是1，一个id是999 999 999 。<br>  这样是不是造成了非常大的空间浪费，再比如 我们的ID是Long 类型 64bit 的数据，大小&#x3D;2048PB&#x3D;2EB，这个量级的数据已经不是硬件(内存)所能承担的了。</p>
<h2 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h2><p>然后我们来讲到工业级的实现: 布隆过滤器</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>布隆过滤器的实现原理其实跟生活中的某些事很像，考试我们不可能每次都考满分，做事也不一定能百分之百的做好，但是能做到百分之七八十 也是能够得到别人的认可。所以他的原理就是用可能会存在一定的<code>误差率</code>的形式来最大限度的减少内存的使用。</p>
<p>怎么实现的其实上边已经解释了大部分内容，但是由于内存空间有限，为了解决空间问题，它使用了地址hash的方式，你了解HashMap 的存储原理，这块也就不难理解。</p>
<p>比如我们有1-20 20个数，想用一个10位长度的数组去做过滤，怎么最大限度的实现？就是通过根据数组长度取余的方式，1和11放到第一位，9和19放到用一个空间表示。<br>这样虽然有一定误差，但如果是上亿的数据量，存储空间可以折半（或者是根据误差率，算出其存储空间）</p>
<p>这样的话如果判断出来某个数存在，那他存在的概率有一半，如果判断出来不存在，那就是百分之百不存在了，这一点在过滤数据上还是很靠谱的。</p>
<p>另外，布隆过滤器 为了解决这个误差率，采用了多个相互独立的哈希函数，保证在给定的空间、误判率下，完成元素判重的过程。 具体的误差率怎么来计算的，（我下来再补充）有兴趣的朋友可以自己了解一下。</p>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><p>由于布隆过滤器的这些特性，他的缺点也是呼之欲出。</p>
<ul>
<li>误差率算一个</li>
<li>由于hash碰撞，他的每个存储空间可能表示多个值，所以不支持删除，删除后它判断某元素不存在有100%准确的特性就不存在了。</li>
</ul>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><p> 只有优缺点都掌握了，我们才可以更好的使用一门技术 ，布隆过滤器 比较适用的部分场景（待补充）</p>
<ul>
<li>网页爬虫对URL的去重，避免爬去相同的URL地址。</li>
<li>垃圾邮件过滤，从数十亿个垃圾邮件列表中判断某邮箱是否是杀垃圾邮箱。</li>
<li>解决数据库缓存击穿，黑客攻击服务器时，会构建大量不存在于缓存中的key向服务器发起请求，在数据量足够大的时候，频繁的数据库查询会导致挂机。</li>
<li>秒杀系统，查看用户是否重复购买。</li>
<li>给两个文件，分别有100亿个query，我们只有1G内存，如何找到两个文件交集？分别给出精确算法和近似算法？<br><code>思路：精确算法利用位图来实现  近似算法利用布隆过滤器实现，将一个文件的中100亿个query放在一个布隆过滤器中，另个一个文件中的数据到布隆过滤器中去查找，若查找到则说明是这两个文件的交集。</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0701(%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8)/" data-id="cld1buvsk000pbjop4botf3xb" data-title="每日一问0701(布隆过滤器)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0620(%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          每日一问0620(服务架构)
        
      </div>
    </a>
  
  
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0710(%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">每日一问0710(规则引擎)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/2019/">2019</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2020/">2020</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2021/">2021</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2022/">2022</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/">学习英语</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/">快速通道</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%91%84%E5%BD%B1/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E4%B9%90/">音乐</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/18/2021/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0303(Spring%E4%BA%AE%E7%9C%BC%E4%BB%A3%E7%A0%81%E6%8A%80%E5%B7%A7)/">每日一问0303(Spring亮眼代码技巧)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2021/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0323(gateway)/">每日一问0323(gateway)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2021/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0326(%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA)/">每日一问0326(链路追踪)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2021/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0328(PorlarDB)/">每日一问0328(PorlarDB)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2021/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0329(%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE)/">每日一问0329(传输协议)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>