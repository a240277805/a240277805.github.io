<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>每日一问1215(es聚合操作) | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="DB 聚合操作 对比es 聚合操作es的aggs可以分为度量聚合和桶聚合，下面就直接实战开发中经常用到的语句。 1、度量聚合：min、max、sum、avg聚合， 度量聚合接收一个输入文档集并生成至少一个统计值sum。 2、桶聚合 桶聚合返回很多子集，并限定输入数据到一个特殊的叫做桶的子集中。可以把桶聚合想象成 类似前面切面功能的东西。 1、term聚合：词条的聚合 2、range聚合和date">
<meta property="og:type" content="article">
<meta property="og:title" content="每日一问1215(es聚合操作)">
<meta property="og:url" content="https://a240277805.github.io/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE1215(es%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="DB 聚合操作 对比es 聚合操作es的aggs可以分为度量聚合和桶聚合，下面就直接实战开发中经常用到的语句。 1、度量聚合：min、max、sum、avg聚合， 度量聚合接收一个输入文档集并生成至少一个统计值sum。 2、桶聚合 桶聚合返回很多子集，并限定输入数据到一个特殊的叫做桶的子集中。可以把桶聚合想象成 类似前面切面功能的东西。 1、term聚合：词条的聚合 2、range聚合和date">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-01-18T07:11:12.360Z">
<meta property="article:modified_time" content="2023-01-18T07:11:12.360Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://a240277805.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2020/每日一问1215(es聚合操作)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE1215(es%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.360Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2020/">2020</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      每日一问1215(es聚合操作)
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="DB-聚合操作-对比"><a href="#DB-聚合操作-对比" class="headerlink" title="DB 聚合操作 对比"></a>DB 聚合操作 对比</h1><h2 id="es-聚合操作"><a href="#es-聚合操作" class="headerlink" title="es 聚合操作"></a>es 聚合操作</h2><p>es的aggs可以分为度量聚合和桶聚合，下面就直接实战开发中经常用到的语句。</p>
<p><strong>1、度量聚合</strong>：min、max、sum、avg聚合， 度量聚合接收一个输入文档集并生成至少一个统计值sum。</p>
<p><strong>2、桶聚合</strong></p>
<p>桶聚合返回很多子集，并限定输入数据到一个特殊的叫做桶的子集中。可以把桶聚合想象成</p>
<p>类似前面切面功能的东西。</p>
<p><strong>1、term聚合</strong>：词条的聚合</p>
<p><strong>2、range聚合和date range聚合</strong></p>
<p><strong>顾名思义，range范围和时间范围聚合，直接上例子</strong></p>
<p><strong>3）桶嵌套：</strong>还可以在聚合的内部再嵌套一个聚合，例如下面再嵌套一个度量的桶，对各个range进行度量统计。</p>
<p><strong>3）数值和日期直方图切面</strong> <strong><a href="https://link.zhihu.com/?target=https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-datehistogram-aggregation.html">Date Histogram Aggregation</a></strong></p>
<p><strong>数值直方图，这个实际应用中比较经常用到，例如每隔</strong>50000ms统计一次数据，用柱形图显示</p>
<p><strong>3、使用过滤器来计算切面，过滤器返回文档数目的切面</strong></p>
<p><strong>谈到性能，filter切面的速度比query切面或包装查询的filter切面更快</strong></p>
<p><strong>一个是查询的过滤，一个是桶里面的过滤，可以看下官方的文档，具体我就不说了</strong><br>123</p>
<h2 id="text聚合"><a href="#text聚合" class="headerlink" title="text聚合"></a>text聚合</h2><p>分词field和 fielddata的工作原理<br>doc value  不分词的所有field，可以执行聚合操作 –&gt; 如果你的某个field不分词，那么在index-time，就会自动生成doc value –&gt; 针对这些不分词的field执行聚合操作的时候，自动就会用doc value来执行。</p>
<p>分词field，是没有doc value的。。。在index-time，如果某个field是分词的，那么是不会给它建立doc value正排索引的，因为分词后，占用的空间过于大，所以默认是不支持分词field进行聚合的</p>
<p>分词field默认没有doc value，所以直接对分词field执行聚合操作，是会报错的</p>
<p>对于分词field，必须打开和使用fielddata，完全存在于纯内存中。。。结构和doc value类似。。。如果是ngram或者是大量term，那么必将占用大量的内存。。。</p>
<p>如果一定要对分词的field执行聚合，那么必须将fielddata&#x3D;true，然后es就会在执行聚合操作的时候，现场将field对应的数据，建立一份fielddata正排索引，fielddata正排索引的结构跟doc value是类似的，但是只会将fielddata正排索引加载到内存中来，然后基于内存中的fielddata正排索引执行分词field的聚合操作</p>
<p>如果直接对分词field执行聚合，报错，提示让我们开启fielddata&#x3D;true，告诉我们，会将&#x3D;&#x3D;fielddata uninverted index&#x3D;&#x3D;（正排索引），加载到内存，会耗费内存空间</p>
<h2 id="为什么fielddata必须在内存？分词的字符串，需要按照term进行聚合，需要执行更加复杂的算法和操作，如果基于磁盘和os-cache，那么性能会很差"><a href="#为什么fielddata必须在内存？分词的字符串，需要按照term进行聚合，需要执行更加复杂的算法和操作，如果基于磁盘和os-cache，那么性能会很差" class="headerlink" title="为什么fielddata必须在内存？分词的字符串，需要按照term进行聚合，需要执行更加复杂的算法和操作，如果基于磁盘和os cache，那么性能会很差"></a>为什么fielddata必须在内存？分词的字符串，需要按照term进行聚合，需要执行更加复杂的算法和操作，如果基于磁盘和os cache，那么性能会很差</h2><p>版权声明：本文为CSDN博主「小小工匠」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yangshangwei/article/details/100148048">https://blog.csdn.net/yangshangwei/article/details/100148048</a></p>
<h2 id="mongo-聚合操作"><a href="#mongo-聚合操作" class="headerlink" title="mongo 聚合操作"></a>mongo 聚合操作</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aaronjcq/article/details/81511224">ES terms聚合统计性能优化实践</a></p>
<p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/eea1d55a9dd4dcbd0536a7d87">DolphinDB 与 Aliyun HybridDB for PostgreSQL 在金融数据集上的比较</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">ES API 官网 create Index</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html">ES high-level 聚合 </a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangkang65/article/details/79163005?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromBaidu-1.control&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromBaidu-1.control">elasticsearch 查询聚合结果排序</a></p>
<p><a target="_blank" rel="noopener" href="https://www.codota.com/code/java/methods/org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramAggregationBuilder/extendedBounds">How to use extendedBoundsmethod</a></p>
<p>*****  <a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/180535">如何使用elasticsearch实现千万级分组的精确聚合</a></p>
<p>**** <a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/82950393">干货 | Elasticsearch Nested类型深入详解</a> &#x2F;&#x2F;解決聚合數組必看</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_limiting_memory_usage.html">Doc Values and Fielddata–限制内存使用</a> &#x2F;&#x2F;解决报错:([parent] Data too large, data for [<http_request>] would be [426348012&#x2F;406.5mb])</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE1215(es%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C)/" data-id="cld1bs9tr002ffynh09g956q2" data-title="每日一问1215(es聚合操作)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE1214(%E6%95%88%E8%83%BD%E5%B9%B3%E5%8F%B0%E7%BB%9F%E8%AE%A1%E8%AE%BE%E8%AE%A1)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          每日一问1214(效能平台统计设计)
        
      </div>
    </a>
  
  
    <a href="/2023/01/18/2020/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE1217(java%E9%9B%86%E6%88%90es)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">每日一问1217(java集成es)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/2019/">2019</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2020/">2020</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2021/">2021</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2022/">2022</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/">学习英语</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/">快速通道</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%91%84%E5%BD%B1/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E4%B9%90/">音乐</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0922(%E6%9E%B6%E6%9E%84)/">每日一问0922(架构)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2022/%E8%BF%B0%E8%81%8C%E6%A8%A1%E6%9D%BF/">述职模板</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/%E8%8B%B1%E6%96%87%E5%8D%95%E8%AF%8D%E7%A7%AF%E7%B4%AF/">英文单词积累</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/%E5%A5%BD%E7%8E%A9%E7%9A%84%E5%9C%B0%E5%9D%80/">好玩的地址</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E6%91%84%E5%BD%B1/%E6%91%84%E5%BD%B1%E5%90%8E%E6%9C%9F/">摄影后期</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>