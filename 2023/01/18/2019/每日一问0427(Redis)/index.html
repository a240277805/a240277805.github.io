<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>每日一问0427(Redis) | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="redis基础redis 简介     存在内存中，读写速度非常快，用于缓存，分布式锁，除此之外，redis 支持事务 、持久化、LUA脚本、LRU驱动事件、多种集群方案。  redis 的线程模型     redis 内部使用 文件事件处理器 file event handler ，这个处理器是单线程的，所以叫单线程模型。采用 IO多路复用机制同时监听多个socket ，根据socket 事件选">
<meta property="og:type" content="article">
<meta property="og:title" content="每日一问0427(Redis)">
<meta property="og:url" content="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="redis基础redis 简介     存在内存中，读写速度非常快，用于缓存，分布式锁，除此之外，redis 支持事务 、持久化、LUA脚本、LRU驱动事件、多种集群方案。  redis 的线程模型     redis 内部使用 文件事件处理器 file event handler ，这个处理器是单线程的，所以叫单线程模型。采用 IO多路复用机制同时监听多个socket ，根据socket 事件选">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png">
<meta property="article:published_time" content="2023-01-18T07:11:12.356Z">
<meta property="article:modified_time" content="2023-01-18T07:11:12.356Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://a240277805.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2019/每日一问0427(Redis)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/" class="article-date">
  <time class="dt-published" datetime="2023-01-18T07:11:12.356Z" itemprop="datePublished">2023-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/2019/">2019</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      每日一问0427(Redis)
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="redis-简介"><a href="#redis-简介" class="headerlink" title="redis 简介"></a>redis 简介</h3><pre><code>     存在内存中，读写速度非常快，用于缓存，分布式锁，除此之外，redis 支持事务 、持久化、LUA脚本、LRU驱动事件、多种集群方案。
</code></pre>
<h3 id="redis-的线程模型"><a href="#redis-的线程模型" class="headerlink" title="redis 的线程模型"></a>redis 的线程模型</h3><pre><code>     redis 内部使用 文件事件处理器 file event handler ，这个处理器是单线程的，所以叫单线程模型。采用 IO多路复用机制同时监听多个socket ，根据socket 事件选择对应的事件处理器。
     test11
     文件事件处理器包括4部分:
     - 多个socket
     - IO多路复用程序
     - 文件事件分派器
     - 事件处理器(连接应答处理器/命令请求处理器/命令回复处理器)
     多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，会将 socket 产生的事件放入队列中排队，事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。
     ![avatar](https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png)
</code></pre>
<h3 id="为啥-redis-单线程模型也能效率这么高？"><a href="#为啥-redis-单线程模型也能效率这么高？" class="headerlink" title="为啥 redis 单线程模型也能效率这么高？"></a>为啥 redis 单线程模型也能效率这么高？</h3><pre><code>     - 纯内存操作
     - 核心是基于非阻塞的 IO 多路复用机制
     - 单线程反而避免了频繁的上下文切换
</code></pre>
<h3 id="redis-线程模型"><a href="#redis-线程模型" class="headerlink" title="redis 线程模型"></a>redis 线程模型</h3><pre><code>     内部使用 file event handler ，这个事件处理器是单线程的，所以 redis 单线程 模型，
     
     IO多路复用，同时监听多个socket
</code></pre>
<h3 id="redis-和-memcached-的区别"><a href="#redis-和-memcached-的区别" class="headerlink" title="redis 和 memcached 的区别"></a>redis 和 memcached 的区别</h3><pre><code>     - redis 支持更丰富的数据类型
     - redis 支持数据的持久化  ,memercache 重启丢失
     - 集群模式 保证高可用
     - memecached 多线程 非阻塞 IO复用 模型，redis 单线程 IO多路复用模型
</code></pre>
<h3 id="几种数据结构"><a href="#几种数据结构" class="headerlink" title="几种数据结构"></a>几种数据结构</h3><pre><code>     字符串String、字典Hash、列表List、集合Set、有序集合SortedSet。
     高级用法：
     - HyperLogLog 供不精确的去重计数功能，比较适合用来做大规模数据的去重统计，例如统计 UV；             
     - Bitmap 位图是支持按 bit 位来存储信息，可以用来实现 布隆过滤器（BloomFilter）；
     - GeoHash  可以用来保存地理位置，并作位置距离计算或者根据半径计算位置等。有没有想过用Redis来实现附近的人？
     - Pub/Sub 功能是订阅发布功能，可以用作简单的消息队列。
     - Pipeline    可以批量执行一组指令，一次性返回全部结果，可以减少频繁的请求应答。     
</code></pre>
<h3 id="pub-x2F-sub有什么缺点？"><a href="#pub-x2F-sub有什么缺点？" class="headerlink" title="pub&#x2F;sub有什么缺点？"></a>pub&#x2F;sub有什么缺点？</h3><pre><code>     在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如RocketMQ等。
</code></pre>
<h3 id="Zset-原理-跳跃表"><a href="#Zset-原理-跳跃表" class="headerlink" title="Zset 原理(跳跃表)"></a>Zset 原理(跳跃表)</h3><pre><code>     跳跃表性质如下：
     - 一个跳表由很多层组成
     - 每一层都是一个有序的链表
     - 最底层的链表(Level 1)包含所有的元素
     - 如果一个元素出现在Level i层的链表中，则在Level i层以下的所有层都将包含该元素
     - 每个节点包含key及其对应的value和一个指向同一层链表的下个节点的指针数组
</code></pre>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><pre><code>     Redis 提供了 RDB 和 AOF 两种持久化方式，RDB是将全量数据集以快照形式写入磁盘，实际上是通过fork 子进程执行,采用二进制压缩存储;AOF以分别日志形式记录 redis 增量，  内存   
</code></pre>
<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><pre><code>     哨兵(3个选举)+ 主从(RDB+AOF)
</code></pre>
<h3 id="如何保证-缓存数据库双写数据一致性"><a href="#如何保证-缓存数据库双写数据一致性" class="headerlink" title="如何保证 缓存数据库双写数据一致性"></a>如何保证 缓存数据库双写数据一致性</h3><pre><code>     - 弱一致性 ，定时任务
     - 强一致性 ，串行化 ，但会影响性能
</code></pre>
<h3 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h3><pre><code>     - 主从
     - 哨兵（Sentinel）: 是一个集群，监控redis 节点，每隔一秒向master发送ping,如果再一段时间内收不到pong，则认为master 下线
     - cluster 集群部署 :采用去中心化的思想;它采用一定方式，在集群中分布存储;节点之间采用轻量协议通讯，减少带宽占用；自动实现负载均衡与高可用，自动实现 failover并且支持动态扩展；内部也需要配置主从，并且内部也是采用哨兵模式，如果集群中master没有slave节点，则master挂掉整个集群进入fail状态，因为集群slot映射补全，如果超过半数master挂掉也会进入fail
</code></pre>
<h3 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h3><pre><code>     - 数据copy 从服务器接收同步命令，同步主服务器数据
     - 命令传播， 主服务器接收一条消息，发出同步命令，从服务器同步该条数据。
     2.8 之前 只要断线 就要复制 ，2.8 之后短时断线 从服务器根据偏移量部分重同步
</code></pre>
<p>​<br>​         <a target="_blank" rel="noopener" href="https://www.cnblogs.com/liyan492/p/9858548.html">redisson,jedis,Lettuce 三者的区别</a><br>​     理器&#x2F;命令请求处理器&#x2F;命令回复处理器)<br>​     多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，会将 socket 产生的事件放入队列中排队，事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。<br>​     <img src="https://www.javazhiyin.com/wp-content/uploads/2018/12/redis-single-thread-model.png" alt="avatar"></p>
<h3 id="BloomFilter-原理"><a href="#BloomFilter-原理" class="headerlink" title="BloomFilter 原理"></a>BloomFilter 原理</h3><p>当一个元素被加入集合时，通过K个散列函数将这个元素映射成一个位数组中的K个点，把它们置为1。检索时，我们只要看看这些点是不是都是1就（大约）知道集合中有没有它了：如果这些点有任何一个0，则被检元素一定不在；如果都是1，则被检元素很可能在。这就是布隆过滤器的基本思想。</p>
<h3 id="Redis的过期策略"><a href="#Redis的过期策略" class="headerlink" title="Redis的过期策略"></a>Redis的过期策略</h3><ul>
<li>定期随机删除</li>
<li>惰性删除</li>
<li>内存淘汰 （（volatile-lru 尝试回收最少使用的键），LRU算法）</li>
</ul>
<h2 id="压缩列表"><a href="#压缩列表" class="headerlink" title="压缩列表"></a>压缩列表</h2><p>​    </p>
<h3 id="缓存雪崩和穿透的解决方案"><a href="#缓存雪崩和穿透的解决方案" class="headerlink" title="缓存雪崩和穿透的解决方案"></a>缓存雪崩和穿透的解决方案</h3><p>####缓存雪崩</p>
<p>同一时间缓存大面积失效，后面请求落到数据库上。</p>
<p>解决方法</p>
<ul>
<li>事前: 保证 redis 集群高可用性，发现宕机尽快补上。选择合适的内存淘汰策略</li>
<li>事中: 本地 ehcache缓存+ hystrix 限流&amp; 降级 ,避免 MySql 崩掉</li>
<li>事后： 利用 redis 持久化机制 保存的数据尽快恢复缓存</li>
</ul>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>热点key 不在缓存中，导致请求直接到了 数据库上，</p>
<p>解决方法</p>
<ul>
<li>缓存无效key 设置过期时间尽量短</li>
<li>布隆过滤器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当一个元素加入布隆过滤器中的时候，会进行如下操作：</span><br><span class="line">   </span><br><span class="line">   使用布隆过滤器中的哈希函数对元素值进行计算，得到哈希值（有几个哈希函数得到几个哈希值）。</span><br><span class="line">   根据得到的哈希值，在位数组中把对应下标的值置为 1。</span><br><span class="line">   当我们需要判断一个元素是否存在于布隆过滤器的时候，会进行如下操作：</span><br><span class="line">   </span><br><span class="line">   对给定元素再次进行相同的哈希计算；</span><br><span class="line">   得到值之后判断位数组中的每个元素是否都为 1，如果值都为 1，那么说明这个值在布隆过滤器中，如果存在一个值不为 1，说明该元素不在布隆过滤器中。</span><br></pre></td></tr></table></figure>
<h2 id="如何部署高可用的Redis集群架构"><a href="#如何部署高可用的Redis集群架构" class="headerlink" title="如何部署高可用的Redis集群架构"></a>如何部署高可用的Redis集群架构</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangshulang1234/article/details/78765308">如何部署高可用的Redis集群架构</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liyan492/p/9858548.html">redisson,jedis,Lettuce 三者的区别</a></p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>批量删除 测试<br>k run –namespace devops redis-client –rm –tty -i –restart&#x3D;’Never’ –image 172.20.60.16:5000&#x2F;library&#x2F;redis:5.0.5-alpine –command – redis-cli -h devops-redis-redis-ha   -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<p>redis-cli    -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<p>redis-cli  -a redis@2020  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a redis@2020 del</p>
<p>redis-cli  -a devops-redis  keys “ctfo:devplatform:gitlabUserToken*” | xargs redis-cli -a devops-redis del</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunternet/p/11306690.html">压缩列表</a></p>
<p>[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jelly12345/p/15223184.html">Redis写时拷贝（COW）总结</a>]</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://a240277805.github.io/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0427(Redis)/" data-id="cld1bs9s40003fynh3anpazdr" data-title="每日一问0427(Redis)" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/01/18/2019/%E5%8D%83%E6%96%B9%E5%AE%98%E7%BD%91%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          千方官网开发工作
        
      </div>
    </a>
  
  
    <a href="/2023/01/18/2019/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0428(Springbean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">每日一问0428(Springbean初始化过程)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/2019/">2019</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2020/">2020</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2021/">2021</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/2022/">2022</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/">学习英语</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/">快速通道</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%91%84%E5%BD%B1/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E4%B9%90/">音乐</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/18/2022/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE0922(%E6%9E%B6%E6%9E%84)/">每日一问0922(架构)</a>
          </li>
        
          <li>
            <a href="/2023/01/18/2022/%E8%BF%B0%E8%81%8C%E6%A8%A1%E6%9D%BF/">述职模板</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD/%E8%8B%B1%E6%96%87%E5%8D%95%E8%AF%8D%E7%A7%AF%E7%B4%AF/">英文单词积累</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E5%BF%AB%E9%80%9F%E9%80%9A%E9%81%93/%E5%A5%BD%E7%8E%A9%E7%9A%84%E5%9C%B0%E5%9D%80/">好玩的地址</a>
          </li>
        
          <li>
            <a href="/2023/01/18/%E6%91%84%E5%BD%B1/%E6%91%84%E5%BD%B1%E5%90%8E%E6%9C%9F/">摄影后期</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>